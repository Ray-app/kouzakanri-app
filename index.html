<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å£åº§ç®¡ç† | Account Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface2: #22263a;
  --border: #2e3350;
  --accent: #4f8ef7;
  --accent2: #7c6af5;
  --success: #3ecf8e;
  --danger: #f7596a;
  --warn: #f0a847;
  --text: #e8eaf6;
  --text2: #8b90b8;
  --text3: #555c8a;
  --mono: 'DM Mono', monospace;
  --sans: 'Noto Sans JP', sans-serif;
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--sans);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.6;
}

/* Layout */
.app-header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 16px 32px;
  display: flex;
  align-items: center;
  gap: 16px;
  position: sticky;
  top: 0;
  z-index: 100;
}
.app-header h1 {
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 0.02em;
  color: var(--text);
}
.app-header h1 span { color: var(--accent); }

.month-nav {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 4px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 4px;
}
.month-nav button {
  background: none;
  border: none;
  color: var(--text2);
  width: 36px;
  height: 36px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 20px;
  transition: all 0.15s;
  display: flex; align-items: center; justify-content: center;
}
.month-nav button:hover { background: var(--border); color: var(--text); }
.month-nav button:active { transform: scale(0.92); }
.month-display {
  font-family: var(--mono);
  font-size: 17px;
  color: var(--accent);
  font-weight: 700;
  min-width: 96px;
  text-align: center;
  letter-spacing: 0.04em;
  cursor: pointer;
  border-radius: 6px;
  padding: 4px 6px;
  transition: background 0.15s;
}
.month-display:hover { background: rgba(79,142,247,0.1); }
.month-nav-today {
  background: none;
  border: 1px solid var(--border);
  color: var(--text3);
  padding: 0 10px;
  height: 28px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
  font-family: var(--sans);
  letter-spacing: 0.04em;
  transition: all 0.15s;
  margin-left: 2px;
  white-space: nowrap;
}
.month-nav-today:hover { border-color: var(--accent); color: var(--accent); background: rgba(79,142,247,0.08); }

/* æœˆé¸æŠã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
.month-picker-overlay {
  position: fixed; inset: 0; z-index: 300;
  display: none;
}
.month-picker-overlay.open { display: block; }
.month-picker {
  position: fixed;
  top: 62px; right: 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: 0 16px 48px rgba(0,0,0,0.6);
  padding: 16px;
  width: 280px;
  z-index: 301;
  animation: popIn 0.15s ease;
}
@keyframes popIn {
  from { opacity:0; transform: translateY(-8px) scale(0.97); }
  to   { opacity:1; transform: translateY(0)   scale(1); }
}
.mp-year-nav {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 12px;
}
.mp-year-nav button {
  background: none; border: none; color: var(--text2);
  cursor: pointer; font-size: 18px; padding: 4px 10px;
  border-radius: 6px; transition: all 0.15s;
}
.mp-year-nav button:hover { background: var(--border); color: var(--text); }
.mp-year { font-family: var(--mono); font-size: 15px; font-weight: 700; color: var(--text); }
.mp-grid {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;
}
.mp-month-btn {
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--text2); border-radius: 8px; padding: 8px 4px;
  cursor: pointer; font-size: 13px; font-family: var(--sans);
  transition: all 0.15s; text-align: center;
}
.mp-month-btn:hover { border-color: var(--accent); color: var(--text); background: rgba(79,142,247,0.08); }
.mp-month-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; font-weight: 700; }
.mp-month-btn.today-mark { border-color: var(--success); color: var(--success); }
.mp-month-btn.active.today-mark { background: var(--accent); color: #fff; }

.main {
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: calc(100vh - 57px);
}

/* Sidebar */
.sidebar {
  background: var(--surface);
  border-right: 1px solid var(--border);
  padding: 24px 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.nav-btn {
  background: none;
  border: none;
  color: var(--text2);
  padding: 10px 16px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-family: var(--sans);
  font-size: 14px;
  text-align: left;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: all 0.15s;
  width: 100%;
}
.nav-btn:hover { background: var(--surface2); color: var(--text); }
.nav-btn.active { background: rgba(79,142,247,0.15); color: var(--accent); font-weight: 500; }
.nav-icon { font-size: 16px; width: 20px; text-align: center; }
.sidebar-section { color: var(--text3); font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; padding: 16px 16px 4px; }

/* Content */
.content { padding: 32px; overflow-y: auto; }

.page { display: none; }
.page.active { display: block; }

/* Cards */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 20px;
}
.card-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.card-title::before { content: ''; display: block; width: 3px; height: 14px; background: var(--accent); border-radius: 2px; }

/* Account Cards */
.account-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; }
.account-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
  position: relative;
  transition: border-color 0.15s;
}
.account-card:hover { border-color: var(--accent); }
.account-card.negative { border-color: var(--danger); }
.account-card.warning { border-color: var(--warn); }

/* å£åº§æ®‹é«˜ãƒ•ãƒ­ãƒ¼ã‚«ãƒ¼ãƒ‰ */
.flow-cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 14px;
  margin-bottom: 20px;
}
.flow-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
  transition: border-color 0.15s;
}
.flow-card.fc-ok     { border-color: var(--border); }
.flow-card.fc-warn   { border-color: var(--warn); }
.flow-card.fc-danger { border-color: var(--danger); }
.flow-card-name { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 14px; }
.flow-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 5px 0;
  font-size: 13px;
}
.flow-row + .flow-row { border-top: 1px solid var(--border); }
.flow-row.flow-result { border-top: 2px solid var(--accent); margin-top: 4px; padding-top: 8px; }
.flow-row.flow-result .flow-val { font-size: 16px; font-weight: 700; }
.flow-lbl { color: var(--text3); font-size: 12px; }
.flow-val { font-family: var(--mono); color: var(--text); }
.flow-val.pos { color: var(--success); }
.flow-val.neg { color: var(--danger); }
.flow-val.warn { color: var(--warn); }
.flow-minbal { font-size: 11px; color: var(--text3); margin-top: 6px; text-align: right; }
.account-name-edit {
  background: none;
  border: none;
  border-bottom: 1px dashed var(--border);
  color: var(--text);
  font-family: var(--sans);
  font-size: 14px;
  font-weight: 700;
  width: 100%;
  margin-bottom: 8px;
  padding: 2px 0;
  outline: none;
}
.account-name-edit:focus { border-bottom-color: var(--accent); }
.account-balance-label { font-size: 11px; color: var(--text3); margin-bottom: 4px; }
.account-balance-input {
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: var(--mono);
  font-size: 18px;
  width: 100%;
  padding: 8px 10px;
  border-radius: 6px;
  outline: none;
  transition: border-color 0.15s;
}
.account-balance-input:focus { border-color: var(--accent); }
.account-balance-display {
  font-family: var(--mono);
  font-size: 22px;
  font-weight: 500;
  margin: 8px 0 4px;
}
.account-balance-display.negative { color: var(--danger); }
.account-balance-display.positive { color: var(--success); }
.account-tags { display: flex; gap: 6px; margin-top: 10px; align-items: center; }
.tag {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 20px;
  border: 1px solid;
  cursor: pointer;
  user-select: none;
  transition: all 0.15s;
}
.tag.transferable { border-color: var(--success); color: var(--success); background: rgba(62,207,142,0.08); }
.tag.not-transferable { border-color: var(--text3); color: var(--text3); }
.account-del { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--text3); cursor: pointer; font-size: 16px; padding: 2px 6px; border-radius: 4px; transition: all 0.15s; }
.account-del:hover { color: var(--danger); background: rgba(247,89,106,0.1); }

/* Form elements */
.form-row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-group label { font-size: 12px; color: var(--text2); font-weight: 500; }
input[type="text"], input[type="number"], input[type="date"], select {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  font-family: var(--sans);
  font-size: 14px;
  outline: none;
  transition: border-color 0.15s;
}
input:focus, select:focus { border-color: var(--accent); }
select option { background: var(--surface2); }

/* Buttons */
.btn {
  padding: 8px 18px;
  border-radius: var(--radius-sm);
  border: none;
  font-family: var(--sans);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: #3d7cf6; transform: translateY(-1px); }
.btn-success { background: var(--success); color: #fff; }
.btn-success:hover { background: #2ab87a; }
.btn-danger { background: rgba(247,89,106,0.15); color: var(--danger); border: 1px solid var(--danger); }
.btn-danger:hover { background: rgba(247,89,106,0.25); }
.btn-ghost { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }
.btn-ghost:hover { background: var(--border); color: var(--text); }
.btn-sm { padding: 4px 12px; font-size: 12px; }

/* Transaction list */
.tx-list { display: flex; flex-direction: column; gap: 6px; margin-top: 12px; max-height: 320px; overflow-y: auto; }
.tx-item {
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  font-size: 13px;
}
.tx-item .tx-date { font-family: var(--mono); color: var(--text3); min-width: 85px; }
.tx-item .tx-name { flex: 1; color: var(--text); }
.tx-item .tx-account { color: var(--text2); font-size: 12px; background: var(--bg); padding: 2px 8px; border-radius: 20px; }
.tx-item .tx-amount { font-family: var(--mono); font-weight: 500; min-width: 90px; text-align: right; }
.tx-item .tx-amount.income { color: var(--success); }
.tx-item .tx-amount.payment { color: var(--danger); }
.tx-item .tx-del { background: none; border: none; color: var(--text3); cursor: pointer; font-size: 14px; padding: 2px 6px; border-radius: 4px; transition: all 0.15s; margin-left: 4px; }
.tx-item .tx-del:hover { color: var(--danger); background: rgba(247,89,106,0.1); }

/* Balance table */
.balance-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
.balance-table th, .balance-table td {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  text-align: right;
}
.balance-table th { color: var(--text2); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.06em; }
.balance-table td:first-child, .balance-table th:first-child { text-align: left; }
.balance-table tr:last-child td { border-bottom: none; }
.balance-table .row-highlight { background: rgba(79,142,247,0.05); }
.balance-table .row-total td { font-weight: 700; background: rgba(79,142,247,0.08); border-top: 1px solid var(--accent); }
.balance-table .row-overunder td { font-weight: 600; background: rgba(0,0,0,0.15); border-top: 1px dashed var(--border); }
.amount-neg { color: var(--danger); font-family: var(--mono); }
.amount-pos { color: var(--success); font-family: var(--mono); }
.amount-neutral { font-family: var(--mono); }

/* Transfer table */
.transfer-row {
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 16px;
  margin-bottom: 8px;
  font-size: 14px;
}
.transfer-arrow { color: var(--accent); font-size: 18px; }
.transfer-from { color: var(--text2); }
.transfer-to { color: var(--text); font-weight: 600; }
.transfer-amount { font-family: var(--mono); font-size: 16px; color: var(--warn); font-weight: 500; margin-left: auto; }
.transfer-alert {
  background: rgba(247,89,106,0.1);
  border: 1px solid var(--danger);
  border-radius: var(--radius-sm);
  padding: 12px 16px;
  color: var(--danger);
  font-size: 14px;
  margin-bottom: 8px;
}

/* Chart */
.chart-container { position: relative; height: 320px; }

/* Margin control */
.margin-control { display: flex; align-items: center; gap: 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px 16px; }
.margin-control label { font-size: 13px; color: var(--text2); }
.margin-control input { width: 120px; }
.margin-control .toggle { display: flex; align-items: center; gap: 8px; margin-left: 16px; font-size: 13px; color: var(--text2); }
.toggle input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--accent); }

/* Tabs */
.tabs { display: flex; gap: 2px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
.tab-btn { padding: 10px 18px; background: none; border: none; color: var(--text2); font-family: var(--sans); font-size: 14px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s; position: relative; top: 1px; }
.tab-btn:hover { color: var(--text); }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Stat cards */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; }
.stat-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
}
.stat-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 6px; }
.stat-value { font-family: var(--mono); font-size: 20px; font-weight: 500; }
.stat-value.pos { color: var(--success); }
.stat-value.neg { color: var(--danger); }

/* Month list in multi-month view */
.month-pills { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
.month-pill { padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border); background: var(--surface2); color: var(--text2); font-size: 13px; font-family: var(--mono); cursor: pointer; transition: all 0.15s; }
.month-pill:hover { border-color: var(--accent); color: var(--accent); }
.month-pill.active { background: rgba(79,142,247,0.2); border-color: var(--accent); color: var(--accent); font-weight: 600; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text3); }

/* Responsive */
@media (max-width: 768px) {
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .app-header h1 { font-size: 16px; }
  .app-header h1 span { display: none; }
  .month-display { font-size: 14px; min-width: 76px; }

  /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã¦ãƒœãƒˆãƒ ãƒŠãƒ“ã«åˆ‡ã‚Šæ›¿ãˆ */
  .main { grid-template-columns: 1fr; }
  .sidebar { display: none; }
  .content { padding: 12px 12px 80px; } /* ãƒœãƒˆãƒ ãƒŠãƒ“åˆ†ã®padding-bottom */

  /* ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç¸¦ç©ã¿ã« */
  .form-row { flex-direction: column; }
  .form-group { min-width: unset !important; width: 100%; }

  /* ã‚«ãƒ¼ãƒ‰ã®paddingç¸®å° */
  .card { padding: 14px; }
  .card-title { font-size: 14px; }

  /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
  .balance-table { font-size: 12px; }
  .balance-table th, .balance-table td { padding: 6px 8px; }

  /* stat-grid 2åˆ— */
  .stat-grid { grid-template-columns: repeat(2, 1fr); }

  /* tx-item ã‚¹ãƒãƒ›å¯¾å¿œ */
  .tx-item { flex-wrap: wrap; gap: 4px; }
  .tx-item .tx-name { flex: 1; min-width: 120px; }
  .tx-item .tx-account { display: none; }

  /* account-grid 1åˆ— */
  .account-grid { grid-template-columns: 1fr; }

  /* flow-cards 1åˆ— */
  .flow-cards-grid { grid-template-columns: 1fr; }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal { min-width: unset; width: 95%; padding: 20px; }

  /* ã‚¿ãƒ– */
  .tab-btn { padding: 8px 12px; font-size: 13px; }
}

/* ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ï¼ˆã‚¹ãƒãƒ›å°‚ç”¨ï¼‰ */
.bottom-nav {
  display: none;
}
@media (max-width: 768px) {
  .bottom-nav {
    display: flex;
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: var(--surface);
    border-top: 1px solid var(--border);
    z-index: 100;
    height: 64px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  .bottom-nav-btn {
    flex: 1;
    min-width: 56px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    background: none;
    border: none;
    color: var(--text3);
    font-size: 10px;
    font-family: var(--sans);
    cursor: pointer;
    padding: 8px 4px;
    transition: color 0.15s;
    white-space: nowrap;
  }
  .bottom-nav-btn .bnav-icon { font-size: 20px; }
  .bottom-nav-btn.active { color: var(--accent); }
  .bottom-nav-btn:hover { color: var(--text); }
}

.empty-state { text-align: center; padding: 40px; color: var(--text3); font-size: 14px; }
.divider { height: 1px; background: var(--border); margin: 20px 0; }
.badge { display: inline-flex; align-items: center; justify-content: center; background: var(--accent); color: white; border-radius: 20px; font-size: 11px; font-weight: 700; min-width: 18px; height: 18px; padding: 0 5px; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 28px; min-width: 360px; max-width: 480px; width: 90%;
  transform: translateY(12px); transition: transform 0.2s;
  box-shadow: 0 24px 60px rgba(0,0,0,0.6);
}
.modal-overlay.open .modal { transform: translateY(0); }
.modal-title { font-size: 16px; font-weight: 700; margin-bottom: 20px; color: var(--text); }
.modal-field { display: flex; flex-direction: column; gap: 4px; margin-bottom: 14px; }
.modal-field label { font-size: 12px; color: var(--text2); font-weight: 500; }
.modal-field input, .modal-field select { width: 100%; }
.modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

/* ç·¨é›†ãƒœã‚¿ãƒ³ */
.tx-edit { background: none; border: none; color: var(--text3); cursor: pointer; font-size: 13px; padding: 2px 6px; border-radius: 4px; transition: all 0.15s; }
.tx-edit:hover { color: var(--accent); background: rgba(79,142,247,0.1); }

/* å®¶è¨ˆç°¿ */
.budget-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; }
.budget-cat-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px;
  transition: border-color 0.15s;
}
.budget-cat-card:hover { border-color: var(--accent); }
.budget-cat-card .cat-name { font-size: 13px; font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
.budget-cat-card .cat-budget { font-family: var(--mono); font-size: 11px; color: var(--text3); margin-bottom: 8px; }
.budget-progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
.budget-progress-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
.budget-cat-card .cat-stats { display: flex; justify-content: space-between; font-size: 12px; }
.cat-spent { font-family: var(--mono); }
.cat-remain.over { color: var(--danger); font-family: var(--mono); }
.cat-remain.ok   { color: var(--success); font-family: var(--mono); }

.kaihi-box {
  display: flex; gap: 16px; flex-wrap: wrap;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 16px; margin-bottom: 16px;
}
.kaihi-item { display: flex; flex-direction: column; gap: 2px; }
.kaihi-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.07em; }
.kaihi-value { font-family: var(--mono); font-size: 18px; font-weight: 500; }

.pace-bar-wrap { display: flex; align-items: center; gap: 10px; margin: 6px 0; }
.pace-bar-wrap label { font-size: 12px; color: var(--text2); min-width: 80px; }
.pace-bar { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; position: relative; }
.pace-fill { height: 100%; border-radius: 4px; }
.pace-marker { position: absolute; top: 0; width: 2px; height: 100%; background: var(--warn); }
.pace-value { font-family: var(--mono); font-size: 12px; min-width: 70px; text-align: right; }

.category-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; flex-shrink: 0; }

.expense-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.expense-table th, .expense-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); text-align: left; }
.expense-table th { color: var(--text2); font-size: 11px; text-transform: uppercase; letter-spacing: 0.06em; }
.expense-table td:last-child, .expense-table th:last-child { text-align: right; }
.expense-table tr:last-child td { border-bottom: none; }
.expense-table tr:hover td { background: rgba(255,255,255,0.02); }

.budget-settings-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
.budget-settings-row:last-child { border-bottom: none; }
.budget-settings-row .cat-label { display: flex; align-items: center; gap: 8px; min-width: 140px; font-size: 14px; }
.budget-settings-row input[type="number"] { width: 130px; }

/* äºˆç®—ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ« */
.budget-mode-bar {
  display: flex; align-items: center; gap: 8px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 10px; padding: 6px 8px; margin-bottom: 16px;
}
.budget-mode-btn {
  flex: 1; padding: 7px 12px; border: none; border-radius: 7px;
  cursor: pointer; font-family: var(--sans); font-size: 13px; font-weight: 500;
  color: var(--text2); background: none; transition: all 0.15s;
}
.budget-mode-btn.active {
  background: var(--accent); color: #fff;
  box-shadow: 0 2px 10px rgba(79,142,247,0.35);
}
.budget-mode-btn:not(.active):hover { color: var(--text); background: var(--border); }

/* æ—¥åˆ¥æ”¯å‡ºè¡¨ */
.daily-table { border-collapse: collapse; font-size: 12px; white-space: nowrap; }
.daily-table th, .daily-table td { border: 1px solid var(--border); padding: 0; vertical-align: middle; }
.daily-table thead th { background: var(--surface2); color: var(--text2); font-weight: 600; font-size: 11px; text-align: center; padding: 6px 10px; }
.daily-table th.th-date { min-width: 48px; position: sticky; left: 0; z-index: 3; background: var(--surface2); }
.daily-table th.th-expense { min-width: 110px; color: var(--text3); }
.daily-table th.th-summary { min-width: 72px; background: var(--surface2); border-left: 2px solid var(--border); }

/* æ—¥ä»˜ã‚»ãƒ« */
.daily-table td.td-date {
  text-align: center; font-family: var(--mono); font-size: 11px; padding: 6px 4px;
  color: var(--text3); position: sticky; left: 0; background: var(--surface); z-index: 1;
  min-width: 48px; line-height: 1.3;
}
.daily-table td.td-date.today   { color: var(--accent); font-weight: 700; background: rgba(79,142,247,0.1); }
.daily-table td.td-date.weekend { color: var(--warn); }
.daily-table tr.row-today td    { background: rgba(79,142,247,0.04); }
.daily-table tr.row-today td.td-date { background: rgba(79,142,247,0.1); }
.daily-table tr:hover td        { filter: brightness(1.08); }

/* æ”¯å‡ºã‚»ãƒ« */
.daily-table td.td-expense { min-width: 110px; max-width: 140px; padding: 5px 8px; vertical-align: top; }
.daily-table td.td-expense-empty { background: rgba(0,0,0,0.08); }
.exp-cell-inner { display: flex; flex-direction: column; gap: 2px; }
.exp-name   { font-size: 12px; color: var(--text); font-weight: 500; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }
.exp-amount { font-family: var(--mono); font-size: 13px; color: var(--danger); font-weight: 700; }
.exp-cat    { font-size: 10px; padding: 1px 6px; border-radius: 10px; border: 1px solid; align-self: flex-start; }

/* å³ç«¯ã‚µãƒãƒªãƒ¼ã‚»ãƒ« */
.daily-table td.td-summary-total, .daily-table td.td-summary-target, .daily-table td.td-summary-diff {
  text-align: right; padding: 5px 10px; min-width: 72px; border-left: 2px solid var(--border); vertical-align: middle;
}
.summary-total { font-family: var(--mono); font-size: 13px; font-weight: 700; color: var(--text); }
.daily-table td.td-summary-target { font-family: var(--mono); font-size: 11px; color: var(--text3); }

/* ãƒ•ãƒƒã‚¿ãƒ¼ */
.daily-table tfoot td { background: var(--surface2); font-weight: 700; font-family: var(--mono); font-size: 12px; border-top: 2px solid var(--accent); padding: 6px 10px; text-align: right; }
.daily-table tfoot td.foot-target { color: var(--text2); }
.daily-table tfoot td.foot-actual { color: var(--accent); }
.daily-table tfoot td.foot-over   { color: var(--danger); }
.daily-table tfoot td.foot-ok     { color: var(--success); }
</style>
</head>
<body>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="editModal" onclick="closeModal(event)">
  <div class="modal">
    <div class="modal-title" id="modalTitle">ç·¨é›†</div>
    <div id="modalBody"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModalDirect()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" id="modalSaveBtn">ä¿å­˜</button>
    </div>
  </div>
</div>

<header class="app-header">
  <h1>ğŸ’³ <span>å£åº§</span>ç®¡ç†</h1>
  <div class="month-nav">
    <button onclick="changeMonth(-1)">â€¹</button>
    <span class="month-display" id="monthDisplay" onclick="toggleMonthPicker()">-</span>
    <button onclick="changeMonth(1)">â€º</button>
    <button class="month-nav-today" onclick="goToToday()">ä»Šæœˆ</button>
  </div>

  <!-- æœˆé¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div class="month-picker-overlay" id="monthPickerOverlay" onclick="closeMonthPicker()">
    <div class="month-picker" onclick="event.stopPropagation()">
      <div class="mp-year-nav">
        <button onclick="mpChangeYear(-1)">â€¹</button>
        <span class="mp-year" id="mpYear">-</span>
        <button onclick="mpChangeYear(1)">â€º</button>
      </div>
      <div class="mp-grid" id="mpGrid"></div>
    </div>
  </div>
</header>

<div class="main">
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-section">ãƒ¡ã‚¤ãƒ³</div>
    <button class="nav-btn active" onclick="showPage('dashboard', this)"><span class="nav-icon">ğŸ“Š</span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
    <button class="nav-btn" onclick="showPage('forecast', this)"><span class="nav-icon">ğŸ”®</span>äºˆæ¸¬å…¥åŠ›</button>
    <button class="nav-btn" onclick="showPage('actual', this)"><span class="nav-icon">âœ…</span>å®Ÿç¸¾å…¥åŠ›</button>
    <button class="nav-btn" onclick="showPage('balances', this)"><span class="nav-icon">ğŸ¦</span>å£åº§æ®‹é«˜è¨­å®š</button>
    <div class="sidebar-section">å®¶è¨ˆç°¿</div>
    <button class="nav-btn" onclick="showPage('kakeibo', this)"><span class="nav-icon">ğŸ“’</span>å®¶è¨ˆç°¿ãƒ»äºˆç®—ç®¡ç†</button>
    <div class="sidebar-section">åˆ†æ</div>
    <button class="nav-btn" onclick="showPage('trend', this)"><span class="nav-icon">ğŸ“ˆ</span>æœˆæ¬¡æ¨ç§»ã‚°ãƒ©ãƒ•</button>
    <div class="sidebar-section">è¨­å®š</div>
    <button class="nav-btn" onclick="showPage('settings', this)"><span class="nav-icon">âš™ï¸</span>å£åº§è¨­å®š</button>
    <button class="nav-btn" onclick="showPage('transfer', this)"><span class="nav-icon">ğŸ”„</span>ãƒ‡ãƒ¼ã‚¿è»¢é€</button>
    <div style="margin-top:auto; padding-top: 20px;">
      <button class="btn btn-danger btn-sm" style="width:100%" onclick="resetAll()">ğŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </nav>

  <!-- Content -->
  <main class="content">

    <!-- Dashboard -->
    <div class="page active" id="page-dashboard">
      <div class="card">
        <div class="card-title">æ®‹é«˜ã‚µãƒãƒªãƒ¼</div>
        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab('summary','dash-forecast',this)">äºˆæ¸¬</button>
          <button class="tab-btn" onclick="switchTab('summary','dash-actual',this)">å®Ÿç¸¾</button>
        </div>
        <div id="dash-forecast" class="tab-content active"></div>
        <div id="dash-actual"   class="tab-content"></div>
      </div>

      <div class="card">
        <div class="card-title">æ¨å¥¨æŒ¯æ›¿</div>
        <div class="margin-control">
          <div class="toggle">
            <input type="checkbox" id="transferOnly" checked onchange="renderDashboard()">
            <label for="transferOnly">æŒ¯æ›¿å¯å£åº§ã®ã¿</label>
          </div>
          <span style="font-size:12px;color:var(--text3);margin-left:8px;">â€» æœ€ä½æ®‹é«˜ã¯å£åº§è¨­å®šã§å€‹åˆ¥ã«è¨­å®š</span>
        </div>
        <div id="transferTable" style="margin-top:14px;"></div>
      </div>
    </div>

    <!-- Forecast Input -->
    <div class="page" id="page-forecast">
      <div class="card">
        <div class="card-title">å…¥é‡‘ãƒ»æ”¯æ‰•ã„è¿½åŠ </div>
        <div class="form-row">
          <div class="form-group">
            <label>æ—¥ä»˜</label>
            <input type="date" id="entryDate">
          </div>
          <div class="form-group" style="flex:1;min-width:120px;">
            <label>åå‰</label>
            <input type="text" id="entryName" placeholder="ä¾‹: çµ¦ä¸">
          </div>
          <div class="form-group">
            <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
            <input type="number" id="entryAmount" placeholder="0">
          </div>
          <div class="form-group">
            <label>å£åº§</label>
            <select id="entryAccount"></select>
          </div>
          <div class="form-group" style="flex-direction:row;gap:8px;align-items:flex-end;">
            <button class="btn btn-success" onclick="addEntry('incomes')">ï¼‹ å…¥é‡‘</button>
            <button class="btn btn-danger" onclick="addEntry('payments')">ï¼ æ”¯æ‰•ã„</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">äºˆæ¸¬ãƒªã‚¹ãƒˆ</div>
        <div id="forecastList"></div>
      </div>
    </div>

    <!-- Actual Input -->
    <div class="page" id="page-actual">
      <div class="card">
        <div class="card-title">å®Ÿç¸¾è¿½åŠ </div>
        <div class="form-row">
          <div class="form-group">
            <label>æ—¥ä»˜</label>
            <input type="date" id="actualDate">
          </div>
          <div class="form-group" style="flex:1;min-width:120px;">
            <label>åå‰</label>
            <input type="text" id="actualName" placeholder="ä¾‹: é›»æ°—ä»£">
          </div>
          <div class="form-group">
            <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
            <input type="number" id="actualAmount" placeholder="0">
          </div>
          <div class="form-group">
            <label>å£åº§</label>
            <select id="actualAccount"></select>
          </div>
          <div class="form-group">
            <label>ç¨®é¡</label>
            <select id="actualType">
              <option value="incomes">å…¥é‡‘</option>
              <option value="payments">æ”¯æ‰•ã„</option>
            </select>
          </div>
          <div class="form-group" style="justify-content:flex-end;">
            <button class="btn btn-primary" onclick="addActual()">è¿½åŠ </button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">å®Ÿç¸¾ãƒªã‚¹ãƒˆ</div>
        <div id="actualList"></div>
      </div>

      <div class="card">
        <div class="card-title">å®Ÿç¸¾æ®‹é«˜</div>
        <div id="actualBalanceTable"></div>
      </div>
    </div>

    <!-- Trend Graph -->
    <div class="page" id="page-trend">
      <div class="card">
        <div class="card-title">å£åº§æ®‹é«˜ æœˆæ¬¡æ¨ç§»ï¼ˆå®Ÿç¸¾ï¼‰</div>
        <div class="chart-container">
          <canvas id="actualTrendChart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-title">åæ”¯ã‚µãƒãƒªãƒ¼ æœˆåˆ¥ï¼ˆå®Ÿç¸¾ï¼‰</div>
        <div class="chart-container">
          <canvas id="incomeExpenseChart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-title">å®¶è¨ˆç°¿ æœˆåˆ¥æ”¯å‡ºï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ç©ã¿ä¸Šã’ï¼‰</div>
        <div class="chart-container">
          <canvas id="kakeiboExpenseChart"></canvas>
        </div>
      </div>
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
          <div class="card-title" style="margin:0;">å®¶è¨ˆç°¿ ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡ºï¼ˆä»Šæœˆï¼‰</div>
          <div style="display:flex;gap:6px;">
            <button id="pieChartBtn" class="btn btn-primary btn-sm" onclick="setPieMode('pie')">ğŸ¥§ å††ã‚°ãƒ©ãƒ•</button>
            <button id="doughnutChartBtn" class="btn btn-ghost btn-sm" onclick="setPieMode('doughnut')">ğŸ© ãƒ‰ãƒ¼ãƒŠãƒ„</button>
          </div>
        </div>
        <div class="chart-container" style="max-width:400px;margin:0 auto;">
          <canvas id="kakeiboPieChart"></canvas>
        </div>
        <div id="pieLegend" style="margin-top:14px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center;"></div>
      </div>
    </div>

    <!-- Settings -->
    <div class="page" id="page-settings">
      <div class="card">
        <div class="card-title">å£åº§è¨­å®š</div>
        <div class="account-grid" id="accountSettings"></div>
        <div style="margin-top:16px;display:flex;gap:10px;">
          <button class="btn btn-primary" onclick="addAccount()">ï¼‹ å£åº§è¿½åŠ </button>
          <button class="btn btn-ghost" onclick="saveAccounts()">ğŸ’¾ ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- å£åº§æ®‹é«˜è¨­å®šï¼ˆç‹¬ç«‹ãƒšãƒ¼ã‚¸ï¼‰ -->
    <div class="page" id="page-balances">
      <div class="card">
        <div class="card-title">ğŸ¦ å£åº§æ®‹é«˜è¨­å®š</div>
        <p style="font-size:13px;color:var(--text2);margin-bottom:16px;">æœˆã”ã¨ã®å®Ÿéš›ã®å£åº§æ®‹é«˜ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚æœˆæ¬¡ã‚°ãƒ©ãƒ•ã®æ®‹é«˜æ¨ç§»ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap;">
          <button class="btn btn-ghost btn-sm" onclick="mbChangeMonth(-1)">â€¹ å‰æœˆ</button>
          <span id="mbMonthLabel" style="font-family:var(--mono);font-size:17px;font-weight:700;color:var(--accent);min-width:90px;text-align:center;">-</span>
          <button class="btn btn-ghost btn-sm" onclick="mbChangeMonth(1)">æ¬¡æœˆ â€º</button>
          <button class="btn btn-sm" style="background:rgba(79,142,247,0.15);color:var(--accent);border:none;" onclick="mbGoToday()">ä»Šæœˆ</button>
        </div>
        <div id="mbInputGrid" style="display:flex;flex-direction:column;gap:10px;"></div>
        <div style="margin-top:20px;display:flex;align-items:center;gap:12px;">
          <button class="btn btn-primary" onclick="saveMonthBalances()">ğŸ’¾ æ®‹é«˜ã‚’ä¿å­˜</button>
          <span id="mbSaveStatus" style="font-size:12px;color:var(--success);"></span>
        </div>
      </div>

      <!-- å…¥åŠ›æ¸ˆã¿æœˆä¸€è¦§ -->
      <div class="card">
        <div class="card-title">å…¥åŠ›æ¸ˆã¿æœˆä¸€è¦§</div>
        <div id="mbSummaryGrid"></div>
      </div>
    </div>

    <!-- Data Transfer -->
    <div class="page" id="page-transfer">

      <!-- ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ -->
      <div class="card">
        <div class="card-title">ğŸ“± ç«¯æœ«é–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’ç§»ã™æ–¹æ³•</div>
        <div style="font-size:13px;color:var(--text2);line-height:1.9;">
          <p>ã“ã®ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
          åˆ¥ã®ç«¯æœ«ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã§ä½¿ã†ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆâ†’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚</p>
          <div style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;">
              <div style="font-weight:700;color:var(--accent);margin-bottom:10px;">â‘  é€ã‚Šå‡ºã™ç«¯æœ«ï¼ˆä¾‹: Surfaceï¼‰</div>
              <ol style="padding-left:16px;display:flex;flex-direction:column;gap:6px;">
                <li>ä¸‹ã®ã€Œã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™</li>
                <li>JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹</li>
                <li>ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’iPhoneã«é€ã‚‹<br><span style="color:var(--text3);font-size:12px;">ï¼ˆãƒ¡ãƒ¼ãƒ«ãƒ»AirDropãƒ»iCloudãƒ»Googleãƒ‰ãƒ©ã‚¤ãƒ–ãªã©ï¼‰</span></li>
              </ol>
            </div>
            <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;">
              <div style="font-weight:700;color:var(--success);margin-bottom:10px;">â‘¡ å—ã‘å–ã‚‹ç«¯æœ«ï¼ˆä¾‹: iPhoneï¼‰</div>
              <ol style="padding-left:16px;display:flex;flex-direction:column;gap:6px;">
                <li>HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’Safariã§é–‹ã</li>
                <li>ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã</li>
                <li>ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ãƒœã‚¿ãƒ³ã§JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</li>
                <li>ãƒ‡ãƒ¼ã‚¿ãŒå¾©å…ƒã•ã‚Œã‚‹ âœ“</li>
              </ol>
            </div>
          </div>
          <div style="margin-top:14px;padding:10px 14px;background:rgba(240,168,71,0.1);border:1px solid var(--warn);border-radius:var(--radius-sm);font-size:12px;color:var(--warn);">
            âš ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚å¿…è¦ãªå ´åˆã¯å…ˆã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãã ã•ã„ã€‚
          </div>
        </div>
      </div>

      <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
      <div class="card">
        <div class="card-title">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã™ï¼‰</div>
        <p style="font-size:13px;color:var(--text2);margin-bottom:16px;">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«ã‚‚ä½¿ãˆã¾ã™ã€‚</p>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="exportData()">â¬‡ï¸ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <span id="exportStatus" style="font-size:12px;color:var(--success);"></span>
        </div>
      </div>

      <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
      <div class="card">
        <div class="card-title">ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼‰</div>
        <p style="font-size:13px;color:var(--text2);margin-bottom:16px;">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ã€‚</p>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
          <button class="btn btn-ghost" onclick="document.getElementById('importFile').click()">â¬†ï¸ JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
          <span id="importStatus" style="font-size:12px;"></span>
        </div>
      </div>

    </div>

    <!-- Kakeibo / Budget -->
    <div class="page" id="page-kakeibo">

      <!-- æœˆåˆ‡æ›¿ï¼ˆãƒšãƒ¼ã‚¸å†…ï¼‰ -->
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
        <button class="btn btn-ghost btn-sm" onclick="changeMonth(-1)">â€¹ å‰æœˆ</button>
        <span style="font-family:var(--mono);font-size:18px;font-weight:700;color:var(--accent);" id="kakeiboMonthLabel">-</span>
        <button class="btn btn-ghost btn-sm" onclick="changeMonth(1)">æ¬¡æœˆ â€º</button>
        <button class="btn btn-sm" style="background:rgba(79,142,247,0.15);color:var(--accent);border:none;margin-left:4px;" onclick="goToToday()">ä»Šæœˆ</button>
      </div>

      <!-- äºˆç®—ãƒ¢ãƒ¼ãƒ‰ï¼‹è¨­å®šã‚«ãƒ¼ãƒ‰ -->
      <div class="card">
        <div class="card-title">æœˆäºˆç®—è¨­å®š</div>

        <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
        <div class="budget-mode-bar">
          <button class="budget-mode-btn active" id="modeBtnCat" onclick="setBudgetMode('category')">ğŸ“Š ã‚«ãƒ†ã‚´ãƒªåˆ¥</button>
          <button class="budget-mode-btn" id="modeBtnTotal" onclick="setBudgetMode('total')">ğŸ’° åˆè¨ˆã®ã¿</button>
          <button class="budget-mode-btn" id="modeBtnBoth" onclick="setBudgetMode('both')">ğŸ”€ ä¸¡æ–¹è¡¨ç¤º</button>
        </div>

        <!-- åˆè¨ˆäºˆç®—å…¥åŠ›ï¼ˆtotal/both ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
        <div id="totalBudgetRow" style="display:none;margin-bottom:14px;">
          <div class="form-row">
            <div class="form-group">
              <label>ä»Šæœˆã®åˆè¨ˆäºˆç®—ï¼ˆå††ï¼‰</label>
              <input type="number" id="totalBudgetInput" placeholder="ä¾‹: 100000" oninput="onTotalBudgetInput()">
            </div>
            <div class="form-group" style="justify-content:flex-end;">
              <button class="btn btn-primary btn-sm" onclick="saveTotalBudget()">ğŸ’¾ ä¿å­˜</button>
            </div>
          </div>
        </div>

        <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥è¨­å®šï¼ˆcategory/both ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
        <div id="categoryBudgetSection">
          <div id="budgetSettingsRows"></div>
          <div style="margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <button class="btn btn-ghost btn-sm" onclick="addCategory()">ï¼‹ ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </button>
            <button class="btn btn-primary btn-sm" onclick="saveBudgets()">ğŸ’¾ ã‚«ãƒ†ã‚´ãƒªäºˆç®—ã‚’ä¿å­˜</button>
            <button class="btn btn-ghost btn-sm" onclick="resetToDefaultCategories()" style="color:var(--text3);">ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
          </div>
        </div>
      </div>

      <!-- ãƒšãƒ¼ã‚¹ãƒ»ä¹–é›¢ -->
      <div class="card">
        <div class="card-title">ä»Šæœˆã®é€²æ—</div>
        <div class="kaihi-box" id="kaihiBox"></div>
        <div id="paceSection"></div>
      </div>

      <!-- æ”¯å‡ºå…¥åŠ› -->
      <div class="card">
        <div class="card-title">æ”¯å‡ºã‚’è¨˜éŒ²</div>
        <div class="form-row">
          <div class="form-group">
            <label>æ—¥ä»˜</label>
            <input type="date" id="expDate">
          </div>
          <div class="form-group" style="flex:1;min-width:120px;">
            <label>å“ç›®</label>
            <input type="text" id="expName" placeholder="ä¾‹: ã‚¹ãƒ¼ãƒ‘ãƒ¼">
          </div>
          <div class="form-group">
            <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
            <input type="number" id="expAmount" placeholder="0">
          </div>
          <div class="form-group">
            <label>ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="expCategory"></select>
          </div>
          <div class="form-group" style="justify-content:flex-end;">
            <button class="btn btn-danger" onclick="addExpense()">è¨˜éŒ²</button>
          </div>
        </div>
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);display:flex;align-items:center;gap:12px;">
          <button class="btn btn-ghost btn-sm" id="zeroDayBtn" onclick="toggleTodayZero()">ğŸ’¤ ä»Šæ—¥ã¯ã‚¼ãƒ­å††</button>
          <span id="zeroDayStatus" style="font-size:12px;color:var(--text3);"></span>
        </div>
      </div>

      <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚²ãƒ¼ã‚¸ -->
      <div class="card">
        <div class="card-title">ã‚«ãƒ†ã‚´ãƒªåˆ¥æ®‹äºˆç®—</div>
        <div class="budget-grid" id="budgetCatGrid"></div>
      </div>

      <!-- æ”¯å‡ºãƒªã‚¹ãƒˆ -->
      <div class="card">
        <div class="card-title" onclick="toggleExpenseList()" style="cursor:pointer;user-select:none;display:flex;align-items:center;justify-content:space-between;">
          <span>æ”¯å‡ºä¸€è¦§</span>
          <span id="expenseListToggleIcon" style="font-size:12px;color:var(--text3);margin-left:auto;">â–² é–‰ã˜ã‚‹</span>
        </div>
        <div id="expenseListWrap">
          <div id="expenseList"></div>
        </div>
      </div>

      <!-- æ—¥åˆ¥æ”¯å‡ºã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ -->
      <div class="card">
        <div class="card-title">æ—¥åˆ¥æ”¯å‡ºè¡¨</div>
        <div style="font-size:12px;color:var(--text3);margin-bottom:12px;">ç¸¦ï¼šæ—¥ä»˜ ï¼ æ¨ªï¼šã‚«ãƒ†ã‚´ãƒª ï¼ å³ç«¯ï¼š1æ—¥ç›®æ¨™ vs å®Ÿç¸¾</div>
        <div id="dailyTableWrap" style="overflow-x:auto;"></div>
      </div>

    </div>

  </main>
</div>

<!-- ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰ -->
<nav class="bottom-nav" id="bottomNav">
  <button class="bottom-nav-btn active" onclick="showPage('dashboard', this, true)"><span class="bnav-icon">ğŸ“Š</span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
  <button class="bottom-nav-btn" onclick="showPage('forecast', this, true)"><span class="bnav-icon">ğŸ”®</span>äºˆæ¸¬</button>
  <button class="bottom-nav-btn" onclick="showPage('actual', this, true)"><span class="bnav-icon">âœ…</span>å®Ÿç¸¾</button>
  <button class="bottom-nav-btn" onclick="showPage('kakeibo', this, true)"><span class="bnav-icon">ğŸ“’</span>å®¶è¨ˆç°¿</button>
  <button class="bottom-nav-btn" onclick="showPage('balances', this, true)"><span class="bnav-icon">ğŸ¦</span>æ®‹é«˜è¨­å®š</button>
  <button class="bottom-nav-btn" onclick="showPage('trend', this, true)"><span class="bnav-icon">ğŸ“ˆ</span>ã‚°ãƒ©ãƒ•</button>
  <button class="bottom-nav-btn" onclick="showPage('settings', this, true)"><span class="bnav-icon">âš™ï¸</span>è¨­å®š</button>
</nav>

<script>
// ============================================================
// State
// ============================================================
let accounts = [];
let monthData   = {};
let actualData  = {};
let monthBalances = {};

let currentYear  = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1;
let charts = {};

let budgetMode = 'category';
let monthTotalBudget = {};

// ============================================================
// Init
// ============================================================
function init() {
  loadAccounts();
  loadData();
  loadBudgetData();
  setTodayDefaults();
  renderAccountSettings();
  updateAccountSelects();
  updateMonthDisplay();
  renderDashboard();
  renderForecastList();
  renderActualList();
}

function setTodayDefaults() {
  const today = new Date().toISOString().split('T')[0];
  ['entryDate','actualDate','expDate'].forEach(id => {
    const el = document.getElementById(id);
    if (el && !el.value) el.value = today;
  });
  const expDateEl = document.getElementById('expDate');
  if (expDateEl) {
    expDateEl.addEventListener('change', updateZeroDayBtn);
  }
  updateZeroDayBtn();
}

// ============================================================
// Persistence
// ============================================================
function saveData() {
  localStorage.setItem('mData', JSON.stringify(monthData));
  localStorage.setItem('aData', JSON.stringify(actualData));
  localStorage.setItem('monthBalances', JSON.stringify(monthBalances));
}
function loadData() {
  try { const d = localStorage.getItem('mData'); if (d) monthData = JSON.parse(d); } catch(e) { monthData = {}; }
  try { const a = localStorage.getItem('aData'); if (a) actualData = JSON.parse(a); } catch(e) { actualData = {}; }
  try { const b = localStorage.getItem('monthBalances'); if (b) monthBalances = JSON.parse(b); } catch(e) { monthBalances = {}; }
}
function saveAccounts() { localStorage.setItem('accounts', JSON.stringify(accounts)); alert('ä¿å­˜ã—ã¾ã—ãŸ'); }
function loadAccounts() {
  try { const d = localStorage.getItem('accounts'); if (d) accounts = JSON.parse(d); } catch(e) { accounts = []; }
}

function resetAll() {
  if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
  monthData = {}; actualData = {};
  saveData();
  renderDashboard(); renderForecastList(); renderActualList();
}

// ============================================================
// Navigation / Month
// ============================================================
function showPage(id, btn, fromBottomNav) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');

  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.bottom-nav-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (fromBottomNav) {
    document.querySelectorAll(`.nav-btn[onclick*="'${id}'"]`).forEach(b => b.classList.add('active'));
  } else {
    document.querySelectorAll(`.bottom-nav-btn[onclick*="'${id}'"]`).forEach(b => b.classList.add('active'));
  }

  if (id === 'trend')      renderTrendCharts();
  if (id === 'dashboard')  renderDashboard();
  if (id === 'kakeibo')    renderKakeibo();
  if (id === 'settings')   renderAccountSettings();
  if (id === 'balances')   { renderMbInputs(); renderMbSummary(); }
}

function switchTab(group, tabId, btn) {
  const parent = btn.closest('.card');
  parent.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(tabId).classList.add('active');
}

function changeMonth(delta) {
  currentMonth += delta;
  if (currentMonth > 12) { currentMonth = 1;  currentYear++; }
  if (currentMonth < 1)  { currentMonth = 12; currentYear--; }
  updateMonthDisplay();
  renderDashboard();
  renderForecastList();
  renderActualList();
  if (document.getElementById('page-kakeibo').classList.contains('active')) renderKakeibo();
}

function goToToday() {
  const now = new Date();
  currentYear  = now.getFullYear();
  currentMonth = now.getMonth() + 1;
  updateMonthDisplay();
  renderDashboard();
  renderForecastList();
  renderActualList();
  if (document.getElementById('page-kakeibo').classList.contains('active')) renderKakeibo();
}

// ---- æœˆé¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ----
let mpYear = new Date().getFullYear();

function toggleMonthPicker() {
  const overlay = document.getElementById('monthPickerOverlay');
  if (overlay.classList.contains('open')) { closeMonthPicker(); }
  else { mpYear = currentYear; renderMonthPicker(); overlay.classList.add('open'); }
}
function closeMonthPicker() { document.getElementById('monthPickerOverlay').classList.remove('open'); }
function mpChangeYear(delta) { mpYear += delta; renderMonthPicker(); }

function renderMonthPicker() {
  document.getElementById('mpYear').textContent = mpYear + 'å¹´';
  const now = new Date();
  const MONTHS = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
  const grid = document.getElementById('mpGrid');
  grid.innerHTML = MONTHS.map((m, i) => {
    const mn = i + 1;
    const isActive = mpYear === currentYear && mn === currentMonth;
    const isToday  = mpYear === now.getFullYear() && mn === now.getMonth() + 1;
    let cls = 'mp-month-btn';
    if (isActive) cls += ' active';
    else if (isToday) cls += ' today-mark';
    return `<button class="${cls}" onclick="selectMonth(${mpYear},${mn})">${m}</button>`;
  }).join('');
}

function selectMonth(year, month) {
  currentYear = year; currentMonth = month;
  updateMonthDisplay(); renderDashboard(); renderForecastList(); renderActualList();
  if (document.getElementById('page-kakeibo').classList.contains('active')) renderKakeibo();
  closeMonthPicker();
}

function updateMonthDisplay() {
  document.getElementById('monthDisplay').textContent = `${currentYear}/${String(currentMonth).padStart(2,'0')}`;
}
function getMonthKey() { return `${currentYear}-${String(currentMonth).padStart(2,'0')}`; }
function ensureMonthData(key, obj) { if (!obj[key]) obj[key] = {incomes:[], payments:[]}; }

// ============================================================
// Accounts
// ============================================================
function addAccount() {
  accounts.push({name:'æ–°å£åº§', transferable:true});
  const newIdx = accounts.length - 1;
  renderAccountSettings();
  updateAccountSelects();
  editAccount(newIdx);
}

function renderAccountSettings() {
  const div = document.getElementById('accountSettings');
  if (!div) return;
  div.innerHTML = '';
  if (accounts.length === 0) {
    div.innerHTML = '<div class="empty-state" style="grid-column:1/-1;">å£åº§ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œï¼‹ å£åº§è¿½åŠ ã€ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
    return;
  }
  accounts.forEach((acc, i) => {
    const card = document.createElement('div');
    card.className = 'account-card';
    card.innerHTML = `
      <button class="account-del" onclick="deleteAccount(${i})">âœ•</button>
      <div class="account-balance-label">å£åº§å</div>
      <div style="font-size:15px;font-weight:700;margin:4px 0 10px;color:var(--text);">${acc.name}</div>
      <div class="account-balance-label">æœ€ä½æ®‹é«˜</div>
      <div style="font-family:var(--mono);font-size:13px;margin:4px 0 10px;color:var(--warn);">${(acc.minBalance||0).toLocaleString()}å††</div>
      <div class="account-tags">
        <span class="tag ${acc.transferable ? 'transferable' : 'not-transferable'}">
          ${acc.transferable ? 'âœ“ æŒ¯æ›¿å¯' : 'âœ• æŒ¯æ›¿ä¸å¯'}
        </span>
        <button class="tx-edit" style="margin-left:auto;" onclick="editAccount(${i})">âœï¸ ç·¨é›†</button>
      </div>
    `;
    div.appendChild(card);
  });
}

function editAccount(i) {
  const acc = accounts[i];
  const body = `
    <div class="modal-field"><label>å£åº§å</label><input type="text" id="mAccName" value="${acc.name}"></div>
    <div class="modal-field">
      <label>æœ€ä½æ®‹é«˜ï¼ˆå††ï¼‰<span style="font-size:11px;color:var(--text3);margin-left:6px;">æ”¯æ‰•ã„å¾Œã«ã“ã®é‡‘é¡ä»¥ä¸Šæ®‹ã™</span></label>
      <input type="number" id="mAccMinBalance" value="${acc.minBalance || 0}" placeholder="0">
    </div>
    <div class="modal-field">
      <label>æŒ¯æ›¿è¨­å®š</label>
      <select id="mAccTransfer">
        <option value="1" ${acc.transferable ? 'selected' : ''}>æŒ¯æ›¿å¯</option>
        <option value="0" ${!acc.transferable ? 'selected' : ''}>æŒ¯æ›¿ä¸å¯</option>
      </select>
    </div>`;
  openModal(`ã€Œ${acc.name}ã€ã‚’ç·¨é›†`, body, () => {
    accounts[i].name         = document.getElementById('mAccName').value.trim() || acc.name;
    accounts[i].minBalance   = Number(document.getElementById('mAccMinBalance').value) || 0;
    accounts[i].transferable = document.getElementById('mAccTransfer').value === '1';
    renderAccountSettings(); updateAccountSelects(); renderDashboard();
  });
}

function deleteAccount(i) {
  if (accounts.length <= 1) { alert('å£åº§ã¯æœ€ä½1ã¤å¿…è¦ã§ã™'); return; }
  if (!confirm(`ã€Œ${accounts[i].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  accounts.splice(i, 1);
  renderAccountSettings(); updateAccountSelects(); renderDashboard();
}

// ============================================================
// æœˆåˆãƒ»æœˆæœ«æ®‹é«˜ç®¡ç†
// ============================================================
let mbYear  = new Date().getFullYear();
let mbMonth = new Date().getMonth() + 1;

function mbGetKey() { return `${mbYear}-${String(mbMonth).padStart(2,'0')}`; }

function mbChangeMonth(delta) {
  mbMonth += delta;
  if (mbMonth > 12) { mbMonth = 1; mbYear++; }
  if (mbMonth < 1)  { mbMonth = 12; mbYear--; }
  renderMbInputs();
}

function mbGoToday() {
  const n = new Date(); mbYear = n.getFullYear(); mbMonth = n.getMonth() + 1;
  renderMbInputs();
}

function renderMbInputs() {
  const lbl = document.getElementById('mbMonthLabel');
  if (lbl) lbl.textContent = `${mbYear}/${String(mbMonth).padStart(2,'0')}`;
  const grid = document.getElementById('mbInputGrid');
  if (!grid) return;
  const key = mbGetKey();
  const stored = monthBalances[key] || {};
  grid.innerHTML = accounts.map((acc, i) => {
    const ob = stored[i]?.open  ?? '';
    const cb = stored[i]?.close ?? '';
    return `
      <div style="display:grid;grid-template-columns:120px 1fr 1fr;gap:10px;align-items:center;
                  background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 16px;">
        <span style="font-size:13px;font-weight:700;color:var(--text);">${acc.name}</span>
        <div style="display:flex;flex-direction:column;gap:3px;">
          <label style="font-size:11px;color:var(--text3);">æœˆåˆæ®‹é«˜ï¼ˆå††ï¼‰</label>
          <input type="number" id="mb_open_${i}" value="${ob}" placeholder="0"
            style="background:var(--bg);border:1px solid var(--border);color:var(--text);
                   padding:6px 10px;border-radius:6px;font-family:var(--mono);font-size:13px;outline:none;width:100%;">
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;">
          <label style="font-size:11px;color:var(--text3);">æœˆæœ«æ®‹é«˜ï¼ˆå††ï¼‰</label>
          <input type="number" id="mb_close_${i}" value="${cb}" placeholder="0"
            style="background:var(--bg);border:1px solid var(--border);color:var(--text);
                   padding:6px 10px;border-radius:6px;font-family:var(--mono);font-size:13px;outline:none;width:100%;">
        </div>
      </div>`;
  }).join('');
}

function saveMonthBalances() {
  const key = mbGetKey();
  monthBalances[key] = {};
  accounts.forEach((_, i) => {
    const o = document.getElementById(`mb_open_${i}`)?.value;
    const c = document.getElementById(`mb_close_${i}`)?.value;
    if (o !== '' || c !== '') {
      monthBalances[key][i] = {
        open:  o !== '' ? Number(o) : null,
        close: c !== '' ? Number(c) : null,
      };
    }
  });
  saveData();
  const st = document.getElementById('mbSaveStatus');
  if (st) { st.textContent = 'âœ“ ä¿å­˜ã—ã¾ã—ãŸ'; setTimeout(() => st.textContent = '', 3000); }
  renderTrendCharts();
  renderMbSummary();
}

function renderMbSummary() {
  const div = document.getElementById('mbSummaryGrid');
  if (!div) return;
  const keys = Object.keys(monthBalances).filter(k => Object.keys(monthBalances[k]).length > 0).sort().reverse();
  if (keys.length === 0) {
    div.innerHTML = '<div class="empty-state">ã¾ã æ®‹é«˜ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
    return;
  }
  div.innerHTML = keys.map(k => {
    const rows = accounts.map((acc, i) => {
      const mb = monthBalances[k]?.[i];
      if (!mb) return '';
      const o = mb.open  != null ? mb.open.toLocaleString()  + 'å††' : 'â€”';
      const c = mb.close != null ? mb.close.toLocaleString() + 'å††' : 'â€”';
      const diff = (mb.close != null && mb.open != null) ? mb.close - mb.open : null;
      const diffHtml = diff != null
        ? `<span style="font-family:var(--mono);font-size:12px;color:${diff>=0?'var(--success)':'var(--danger)'};">${diff>=0?'+':''}${diff.toLocaleString()}å††</span>`
        : '';
      return `<div style="display:flex;align-items:center;gap:12px;font-size:13px;padding:4px 0;border-bottom:1px solid var(--border);">
        <span style="min-width:100px;color:var(--text2);">${acc.name}</span>
        <span style="font-family:var(--mono);color:var(--text3);font-size:12px;">æœˆåˆ</span>
        <span style="font-family:var(--mono);">${o}</span>
        <span style="font-family:var(--mono);color:var(--text3);font-size:12px;">â†’ æœˆæœ«</span>
        <span style="font-family:var(--mono);">${c}</span>
        ${diffHtml}
        <button class="tx-del" style="margin-left:auto;" onclick="deleteMbEntry('${k}',${i})">âœ•</button>
      </div>`;
    }).filter(Boolean).join('');
    return `<div style="margin-bottom:16px;">
      <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:var(--accent);margin-bottom:8px;
                  cursor:pointer;" onclick="mbJumpTo('${k}')">${k} âœ</div>
      ${rows}
    </div>`;
  }).join('');
}

function deleteMbEntry(key, i) {
  if (!monthBalances[key]) return;
  delete monthBalances[key][i];
  if (Object.keys(monthBalances[key]).length === 0) delete monthBalances[key];
  saveData(); renderMbSummary(); renderTrendCharts();
}

function mbJumpTo(key) {
  const [y, m] = key.split('-').map(Number);
  mbYear = y; mbMonth = m; renderMbInputs();
}

function updateAccountSelects() {
  ['entryAccount','actualAccount'].forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    const prev = sel.value;
    sel.innerHTML = '';
    accounts.forEach((a, i) => {
      const opt = document.createElement('option');
      opt.value = i; opt.text = a.name;
      sel.appendChild(opt);
    });
    if (prev < accounts.length) sel.value = prev;
  });
}

// ============================================================
// Transactions
// ============================================================
function addEntry(type) {
  const key = getMonthKey();
  ensureMonthData(key, monthData);
  const date    = document.getElementById('entryDate').value   || new Date().toISOString().split('T')[0];
  const name    = document.getElementById('entryName').value   || 'æœªå…¥åŠ›';
  const amount  = Number(document.getElementById('entryAmount').value) || 0;
  const account = Number(document.getElementById('entryAccount').value);
  monthData[key][type].push({date, name, amount, account});
  document.getElementById('entryName').value   = '';
  document.getElementById('entryAmount').value = '';
  saveData(); renderForecastList(); renderDashboard();
}

function addActual() {
  const key = getMonthKey();
  ensureMonthData(key, actualData);
  const date    = document.getElementById('actualDate').value   || new Date().toISOString().split('T')[0];
  const name    = document.getElementById('actualName').value   || 'æœªå…¥åŠ›';
  const amount  = Number(document.getElementById('actualAmount').value) || 0;
  const account = Number(document.getElementById('actualAccount').value);
  const type    = document.getElementById('actualType').value;
  actualData[key][type].push({date, name, amount, account});
  document.getElementById('actualName').value   = '';
  document.getElementById('actualAmount').value = '';
  saveData(); renderActualList();
}

// ============================================================
// Render Lists
// ============================================================
function renderForecastList() {
  const key = getMonthKey();
  const div = document.getElementById('forecastList');
  if (!div) return;
  const data = monthData[key];
  if (!data || (data.incomes.length === 0 && data.payments.length === 0)) {
    div.innerHTML = '<div class="empty-state">ã“ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  const all = [
    ...data.incomes.map((t,i) => ({...t, type:'income', i})),
    ...data.payments.map((t,i) => ({...t, type:'payment', i})),
  ].sort((a,b) => a.date.localeCompare(b.date));

  div.innerHTML = `<div class="tx-list">
    ${all.map(t => `
      <div class="tx-item">
        <span class="tx-date">${t.date}</span>
        <span class="tx-name">${t.name}</span>
        <span class="tx-account">${accounts[t.account]?.name || '?'}</span>
        <span class="tx-amount ${t.type}">${t.type==='income' ? '+' : '-'}${t.amount.toLocaleString()}å††</span>
        <button class="tx-edit" onclick="editForecastTx('${t.type==='income'?'incomes':'payments'}',${t.i})">âœï¸</button>
        <button class="tx-del" onclick="deleteTx('${t.type==='income'?'incomes':'payments'}',${t.i})">âœ•</button>
      </div>
    `).join('')}
  </div>`;
}

function deleteTx(type, idx) {
  const key = getMonthKey();
  monthData[key][type].splice(idx, 1);
  saveData(); renderForecastList(); renderDashboard();
}

function renderActualList() {
  const key = getMonthKey();
  const listDiv = document.getElementById('actualList');
  const tableDiv = document.getElementById('actualBalanceTable');
  if (!listDiv) return;
  const data = actualData[key];

  if (!data || (data.incomes.length === 0 && data.payments.length === 0)) {
    listDiv.innerHTML = '<div class="empty-state">ã“ã®æœˆã®å®Ÿç¸¾ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    if (tableDiv) tableDiv.innerHTML = '';
    return;
  }

  const all = [
    ...data.incomes.map((t,i) => ({...t, type:'incomes', i})),
    ...data.payments.map((t,i) => ({...t, type:'payments', i})),
  ].sort((a,b) => a.date.localeCompare(b.date));

  listDiv.innerHTML = `<div class="tx-list">
    ${all.map(t => `
      <div class="tx-item">
        <span class="tx-date">${t.date}</span>
        <span class="tx-name">${t.name}</span>
        <span class="tx-account">${accounts[t.account]?.name || '?'}</span>
        <span class="tx-amount ${t.type==='incomes'?'income':'payment'}">${t.type==='incomes' ? '+' : '-'}${t.amount.toLocaleString()}å††</span>
        <button class="tx-edit" onclick="editActualTx('${t.type}',${t.i})">âœï¸</button>
        <button class="tx-del" onclick="deleteActualTx('${t.type}',${t.i})">âœ•</button>
      </div>
    `).join('')}
  </div>`;

  if (tableDiv) {
    const {incomesSum, paymentsSum} = calcBalances(actualData[key]);
    tableDiv.innerHTML = buildBalanceTable(incomesSum, paymentsSum,
      accounts.map((_,i) => (incomesSum[i]||0) - (paymentsSum[i]||0)));
  }
}

function deleteActualTx(type, idx) {
  const key = getMonthKey();
  actualData[key][type].splice(idx, 1);
  saveData(); renderActualList();
}

// ============================================================
// Balance Calculation
// ============================================================
function calcBalances(data) {
  let balances    = accounts.map(() => 0);
  let incomesSum  = Array(accounts.length).fill(0);
  let paymentsSum = Array(accounts.length).fill(0);
  if (!data) return {postBalances: balances, incomesSum, paymentsSum};
  (data.incomes || []).forEach(t => {
    if (t.account < accounts.length) { balances[t.account] += t.amount; incomesSum[t.account] += t.amount; }
  });
  (data.payments || []).forEach(t => {
    if (t.account < accounts.length) { balances[t.account] -= t.amount; paymentsSum[t.account] += t.amount; }
  });
  return {postBalances: balances, incomesSum, paymentsSum};
}

function buildBalanceTable(incomesSum, paymentsSum, postBalances, openBalances) {
  const total = (arr) => arr.reduce((s,v) => s+v, 0);
  const fmtVal = (v, cls) => {
    const neg = v < 0;
    const c = cls || (neg ? 'amount-neg' : v > 0 ? 'amount-pos' : 'amount-neutral');
    return `<span class="${c}">${neg ? '-' : (cls==='amount-pos'?'+':'')}${Math.abs(v).toLocaleString()}å††</span>`;
  };

  const hasOpen = openBalances && openBalances.some(v => v != null);
  const endBal = accounts.map((_, i) => {
    const o = (openBalances && openBalances[i] != null) ? openBalances[i] : 0;
    return o + (incomesSum[i] || 0) - (paymentsSum[i] || 0);
  });

  let rows = [];
  if (hasOpen) rows.push({label:'æœˆåˆæ®‹é«˜', vals: openBalances.map(v => v ?? 0), cls:'amount-neutral'});
  rows.push({label:'ï¼‹ å…¥é‡‘', vals: incomesSum, cls:'amount-pos'});
  rows.push({label:'ï¼ æ”¯æ‰•ã„', vals: paymentsSum, cls:'amount-neg'});
  rows.push({label: hasOpen ? 'æœˆæœ«è¦‹è¾¼' : 'åæ”¯', vals: endBal, highlight: true});

  let html = `<table class="balance-table">
    <tr><th>é …ç›®</th>${accounts.map(a=>`<th>${a.name}</th>`).join('')}<th>åˆè¨ˆ</th></tr>`;
  rows.forEach((r, ri) => {
    const rowClass = r.highlight ? 'row-total' : (ri%2===0 ? '' : 'row-highlight');
    html += `<tr class="${rowClass}">
      <td>${r.label}</td>
      ${r.vals.map(v => `<td>${fmtVal(v, r.cls)}</td>`).join('')}
      <td>${fmtVal(total(r.vals), r.cls||'')}</td>
    </tr>`;
  });
  html += '</table>';
  return html;
}

// ============================================================
// Dashboard
// ============================================================
function renderDashboard() {
  const key    = getMonthKey();
  const fData  = monthData[key];
  const aData  = actualData[key];
  const mbData = monthBalances[key] || {};
  const openBalances = accounts.map((_, i) => mbData[i]?.open ?? null);

  const {incomesSum: fInc, paymentsSum: fPay} = calcBalances(fData);
  const {incomesSum: aInc, paymentsSum: aPay} = calcBalances(aData);

  const fEndBal = accounts.map((_, i) => {
    const o = openBalances[i] ?? 0;
    return o + (fInc[i] || 0) - (fPay[i] || 0);
  });

  const fDiv = document.getElementById('dash-forecast');
  const aDiv = document.getElementById('dash-actual');
  if (fDiv) fDiv.innerHTML = buildBalanceTable(fInc, fPay, fEndBal, openBalances);
  if (aDiv) aDiv.innerHTML = buildBalanceTable(aInc, aPay,
    accounts.map((_,i) => (openBalances[i]??0) + (aInc[i]||0) - (aPay[i]||0)),
    openBalances);

  renderTransferTable(fEndBal);
}

// ============================================================
// Transfer Table
// ============================================================
function renderTransferTable(postBalances) {
  const div = document.getElementById('transferTable');
  if (!div) return;
  const transferOnly = document.getElementById('transferOnly').checked;
  let balances = [...postBalances];
  let html = '';

  balances.forEach((b, i) => {
    const minBal = accounts[i].minBalance || 0;
    if (b >= minBal) return;
    let remain = Math.ceil((minBal - b) / 1000) * 1000;
    for (let j = 0; j < accounts.length; j++) {
      if (j === i) continue;
      const minBalJ = accounts[j].minBalance || 0;
      if (balances[j] <= minBalJ) continue;
      if (transferOnly && !accounts[j].transferable) continue;
      let send = Math.min(Math.floor((balances[j] - minBalJ) / 1000) * 1000, remain);
      if (send <= 0) continue;
      balances[i] += send; balances[j] -= send;
      html += `
        <div class="transfer-row">
          <span class="transfer-from">${accounts[j].name}</span>
          <span class="transfer-arrow">â†’</span>
          <span class="transfer-to">${accounts[i].name}</span>
          <span class="transfer-amount">${send.toLocaleString()}å††</span>
        </div>`;
      remain -= send;
    }
    if (remain > 0) {
      html += `<div class="transfer-alert">âš  ${accounts[i].name} ã«è¿½åŠ ã§ ${remain.toLocaleString()}å†† ã®å…¥é‡‘ãŒå¿…è¦ã§ã™ï¼ˆæœ€ä½æ®‹é«˜ ${minBal.toLocaleString()}å†† ç¢ºä¿ã®ãŸã‚ï¼‰</div>`;
    }
  });
  div.innerHTML = html || '<div class="empty-state" style="padding:20px;">æŒ¯æ›¿ã¯ä¸è¦ã§ã™ âœ“</div>';
}

// ============================================================
// Trend Charts
// ============================================================
function renderTrendCharts() {
  // [ä¿®æ­£â‘¢] expenseData ã®ã‚­ãƒ¼ã‚‚æœˆè»¸ã«å«ã‚ã‚‹
  const months = getAllMonthKeys().sort();
  if (months.length === 0) {
    ['actualTrendChart','incomeExpenseChart','kakeiboExpenseChart','kakeiboPieChart'].forEach(id => {
      if (charts[id]) { charts[id].destroy(); delete charts[id]; }
    });
    return;
  }

  const labels = months;
  const colors = ['#4f8ef7','#3ecf8e','#f7596a','#f0a847','#7c6af5','#f782c2','#45cde4','#a8e86c'];

  const openDatasets = accounts.map((acc, ai) => ({
    label: acc.name + 'ï¼ˆæœˆåˆï¼‰',
    data: months.map(k => monthBalances[k]?.[ai]?.open ?? null),
    borderColor: colors[ai % colors.length],
    backgroundColor: 'transparent',
    borderDash: [4, 4],
    tension: 0.3, fill: false, pointRadius: 3, spanGaps: true,
  }));
  const closeDatasets = accounts.map((acc, ai) => ({
    label: acc.name + 'ï¼ˆæœˆæœ«ï¼‰',
    data: months.map(k => monthBalances[k]?.[ai]?.close ?? null),
    borderColor: colors[ai % colors.length],
    backgroundColor: colors[ai % colors.length] + '22',
    tension: 0.3, fill: false, pointRadius: 4, spanGaps: true,
  }));
  buildLineChart('actualTrendChart', labels, [...closeDatasets, ...openDatasets]);

  const incData = months.map(k => (actualData[k]?.incomes  || []).reduce((s,t) => s+t.amount, 0));
  const expData = months.map(k => (actualData[k]?.payments || []).reduce((s,t) => s+t.amount, 0));
  buildBarChart('incomeExpenseChart', labels, [
    {label:'å…¥é‡‘ï¼ˆå®Ÿç¸¾ï¼‰', data: incData, backgroundColor: '#3ecf8e99', borderColor:'#3ecf8e', borderWidth:1},
    {label:'æ”¯æ‰•ï¼ˆå®Ÿç¸¾ï¼‰', data: expData, backgroundColor: '#f7596a99', borderColor:'#f7596a', borderWidth:1},
  ]);

  if (budgetCategories.length > 0) {
    const kakeiboDatasets = budgetCategories.map((cat, ci) => ({
      label: cat.name,
      data: months.map(k => (expenseData[k] || []).filter(e => e.category === ci).reduce((s,e) => s+e.amount, 0)),
      backgroundColor: CAT_COLORS[ci % CAT_COLORS.length] + 'cc',
      borderColor: CAT_COLORS[ci % CAT_COLORS.length],
      borderWidth: 1,
    })).filter(ds => ds.data.some(v => v > 0));

    const ctx = document.getElementById('kakeiboExpenseChart');
    if (ctx) {
      if (charts['kakeiboExpenseChart']) charts['kakeiboExpenseChart'].destroy();
      charts['kakeiboExpenseChart'] = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: { labels, datasets: kakeiboDatasets },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#8b90b8', font:{family:"'DM Mono',monospace",size:11} } } },
          scales: {
            x: { stacked: true, ticks: {color:'#8b90b8'}, grid:{color:'#2e3350'} },
            y: { stacked: true, ticks: {color:'#8b90b8', callback: v => v.toLocaleString()+'å††'}, grid:{color:'#2e3350'} },
          },
        },
      });
    }
  }

  renderPieChart();
}

let pieMode = 'pie';
function setPieMode(mode) {
  pieMode = mode;
  document.getElementById('pieChartBtn').className     = mode === 'pie'      ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm';
  document.getElementById('doughnutChartBtn').className = mode === 'doughnut' ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm';
  renderPieChart();
}

function renderPieChart() {
  const key = getMonthKey();
  const expenses = expenseData[key] || [];
  const ctx = document.getElementById('kakeiboPieChart');
  const legendDiv = document.getElementById('pieLegend');
  if (!ctx) return;

  const pieData = budgetCategories.map((cat, ci) =>
    expenses.filter(e => e.category === ci).reduce((s,e) => s+e.amount, 0)
  );
  const total = pieData.reduce((s,v) => s+v, 0);

  if (charts['kakeiboPieChart']) { charts['kakeiboPieChart'].destroy(); delete charts['kakeiboPieChart']; }

  if (!pieData.some(v => v > 0)) {
    if (legendDiv) legendDiv.innerHTML = '<span style="color:var(--text3);font-size:13px;">ä»Šæœˆã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</span>';
    return;
  }

  const activeLabels = budgetCategories.map((c,i) => ({name:c.name, val:pieData[i], i})).filter(d => d.val > 0);

  charts['kakeiboPieChart'] = new Chart(ctx.getContext('2d'), {
    type: pieMode,
    data: {
      labels: activeLabels.map(d => d.name),
      datasets: [{
        data: activeLabels.map(d => d.val),
        backgroundColor: activeLabels.map(d => CAT_COLORS[d.i % CAT_COLORS.length] + 'dd'),
        borderColor: activeLabels.map(d => CAT_COLORS[d.i % CAT_COLORS.length]),
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => { const v=ctx.parsed; const pct=total>0?(v/total*100).toFixed(1):0; return ` ${v.toLocaleString()}å†† (${pct}%)`; } } }
      }
    }
  });

  if (legendDiv) {
    legendDiv.innerHTML = activeLabels.map(d => {
      const pct = total > 0 ? (d.val / total * 100).toFixed(1) : 0;
      return `<div style="display:flex;align-items:center;gap:5px;font-size:12px;">
        <span style="width:10px;height:10px;border-radius:2px;background:${CAT_COLORS[d.i % CAT_COLORS.length]};flex-shrink:0;"></span>
        <span style="color:var(--text2);">${d.name}</span>
        <span style="font-family:var(--mono);color:var(--text);font-weight:600;">${d.val.toLocaleString()}å††</span>
        <span style="color:var(--text3);">${pct}%</span>
      </div>`;
    }).join('');
  }
}

function buildLineChart(canvasId, labels, datasets) {
  const ctx = document.getElementById(canvasId);
  if (!ctx) return;
  if (charts[canvasId]) charts[canvasId].destroy();
  charts[canvasId] = new Chart(ctx.getContext('2d'), {
    type: 'line', data: {labels, datasets},
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#8b90b8', font:{family:"'DM Mono',monospace",size:12} } } },
      scales: {
        x: { ticks: {color:'#8b90b8'}, grid:{color:'#2e3350'} },
        y: { ticks: {color:'#8b90b8', callback: v => v.toLocaleString()+'å††'}, grid:{color:'#2e3350'} },
      },
    },
  });
}

function buildBarChart(canvasId, labels, datasets) {
  const ctx = document.getElementById(canvasId);
  if (!ctx) return;
  if (charts[canvasId]) charts[canvasId].destroy();
  charts[canvasId] = new Chart(ctx.getContext('2d'), {
    type: 'bar', data: {labels, datasets},
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#8b90b8', font:{family:"'DM Mono',monospace",size:12} } } },
      scales: {
        x: { ticks: {color:'#8b90b8'}, grid:{color:'#2e3350'} },
        y: { ticks: {color:'#8b90b8', callback: v => v.toLocaleString()+'å††'}, grid:{color:'#2e3350'} },
      },
    },
  });
}

// [ä¿®æ­£â‘¢] expenseData ã®ã‚­ãƒ¼ã‚‚å«ã‚ã‚‹ã‚ˆã†ä¿®æ­£
function getAllMonthKeys() {
  const keys = new Set([
    ...Object.keys(monthData),
    ...Object.keys(actualData),
    ...Object.keys(expenseData),
  ]);
  return [...keys];
}

// ============================================================
// Kakeibo (å®¶è¨ˆç°¿) State & Constants
// ============================================================
const CAT_COLORS = ['#4f8ef7','#3ecf8e','#f7596a','#f0a847','#7c6af5','#f782c2','#45cde4','#a8e86c'];

const DEFAULT_CATEGORIES = [
  {name:'é£Ÿè²»',     budget:30000},
  {name:'å¤–é£Ÿ',     budget:15000},
  {name:'æ—¥ç”¨å“',   budget:10000},
  {name:'äº¤é€šè²»',   budget:8000},
  {name:'å¨¯æ¥½ãƒ»è¶£å‘³',budget:10000},
  {name:'åŒ»ç™‚',     budget:5000},
  {name:'ã‚µãƒ–ã‚¹ã‚¯', budget:5000},
  {name:'ãã®ä»–',   budget:10000},
];

let budgetCategories = [];
let expenseData = {};
let zeroDays = {};
let monthCatBudget = {};

// ---- persistence ----
function saveBudgetData() {
  localStorage.setItem('budgetCats', JSON.stringify(budgetCategories));
  localStorage.setItem('expenseData', JSON.stringify(expenseData));
  localStorage.setItem('monthTotalBudget', JSON.stringify(monthTotalBudget));
  localStorage.setItem('budgetMode', budgetMode);
  localStorage.setItem('zeroDays', JSON.stringify(zeroDays));
  localStorage.setItem('monthCatBudget', JSON.stringify(monthCatBudget));
}
function loadBudgetData() {
  try { const c = localStorage.getItem('budgetCats'); budgetCategories = c ? JSON.parse(c) : JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)); } catch(e) { budgetCategories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)); }
  try { const e = localStorage.getItem('expenseData'); expenseData = e ? JSON.parse(e) : {}; } catch(e) { expenseData = {}; }
  try { const m = localStorage.getItem('monthTotalBudget'); monthTotalBudget = m ? JSON.parse(m) : {}; } catch(e) { monthTotalBudget = {}; }
  try { const z = localStorage.getItem('zeroDays'); zeroDays = z ? JSON.parse(z) : {}; } catch(e) { zeroDays = {}; }
  try { const mc = localStorage.getItem('monthCatBudget'); monthCatBudget = mc ? JSON.parse(mc) : {}; } catch(e) { monthCatBudget = {}; }
  const bm = localStorage.getItem('budgetMode');
  budgetMode = bm || 'category';
}

// [ä¿®æ­£â‘ ] saveBudgets ã¯1ã¤ã ã‘å®šç¾©ï¼ˆé‡è¤‡å‰Šé™¤ã€æœˆåˆ¥äºˆç®—å¯¾å¿œç‰ˆã®ã¿æ®‹ã™ï¼‰
function saveBudgets() {
  const key = getMonthKey();
  const rows = document.querySelectorAll('.budget-settings-row');
  const newNames = [];
  const newBudgets = [];
  rows.forEach(row => {
    const nameEl   = row.querySelector('.cat-name-input');
    const budgetEl = row.querySelector('.cat-budget-input');
    if (nameEl && budgetEl) {
      newNames.push(nameEl.value.trim() || 'æœªå…¥åŠ›');
      newBudgets.push(Number(budgetEl.value) || 0);
    }
  });
  budgetCategories = newNames.map((name, i) => ({name, budget: newBudgets[i]}));
  monthCatBudget[key] = [...newBudgets];
  saveBudgetData();
  updateExpCategorySelect();
  renderKakeibo();
  alert('äºˆç®—ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

function addCategory() {
  budgetCategories.push({name:'æ–°ã‚«ãƒ†ã‚´ãƒª', budget:0});
  renderBudgetSettings();
}

function resetToDefaultCategories() {
  if (!confirm('ã‚«ãƒ†ã‚´ãƒªã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒªã‚»ãƒƒãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªè¨­å®šã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼ˆæ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã‚Šã¾ã™ï¼‰ã€‚')) return;
  budgetCategories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
  saveBudgetData();
  updateExpCategorySelect();
  renderKakeibo();
}

// æ”¯å‡ºä¸€è¦§ã®é–‹é–‰
let expenseListOpen = true;
function toggleExpenseList() {
  expenseListOpen = !expenseListOpen;
  const wrap = document.getElementById('expenseListWrap');
  const icon = document.getElementById('expenseListToggleIcon');
  if (wrap) wrap.style.display = expenseListOpen ? '' : 'none';
  if (icon) icon.textContent = expenseListOpen ? 'â–² é–‰ã˜ã‚‹' : 'â–¼ é–‹ã';
}

function deleteCategory(i) {
  if (!confirm(`ã€Œ${budgetCategories[i].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  budgetCategories.splice(i, 1);
  renderBudgetSettings();
}

// ---- äºˆç®—ãƒ¢ãƒ¼ãƒ‰ ----
function setBudgetMode(mode) {
  budgetMode = mode;
  saveBudgetData();
  applyBudgetModeUI();
}

function applyBudgetModeUI() {
  const totalRow = document.getElementById('totalBudgetRow');
  const catSec   = document.getElementById('categoryBudgetSection');
  if (totalRow) totalRow.style.display = (budgetMode === 'total' || budgetMode === 'both') ? '' : 'none';
  if (catSec)   catSec.style.display   = (budgetMode === 'category' || budgetMode === 'both') ? '' : 'none';
  ['Cat','Total','Both'].forEach(n => {
    const btn = document.getElementById('modeBtn'+n);
    if (btn) btn.classList.toggle('active', budgetMode === n.toLowerCase());
  });
  const key = getMonthKey();
  const inp = document.getElementById('totalBudgetInput');
  if (inp) inp.value = monthTotalBudget[key] || '';
}

function onTotalBudgetInput() {}

function saveTotalBudget() {
  const key = getMonthKey();
  const val = Number(document.getElementById('totalBudgetInput')?.value) || 0;
  monthTotalBudget[key] = val;
  saveBudgetData();
  renderKakeibo();
}

function getEffectiveTotalBudget() {
  const key = getMonthKey();
  if (budgetMode === 'total') return monthTotalBudget[key] || 0;
  if (budgetMode === 'both')  return monthTotalBudget[key] || getCatBudgets(key).reduce((s,v) => s+v, 0);
  return getCatBudgets(key).reduce((s,v) => s+v, 0);
}

// ---- selects ----
function updateExpCategorySelect() {
  const sel = document.getElementById('expCategory');
  if (!sel) return;
  const prev = sel.value;
  sel.innerHTML = '';
  budgetCategories.forEach((c, i) => {
    const opt = document.createElement('option');
    opt.value = i; opt.text = c.name;
    sel.appendChild(opt);
  });
  if (prev < budgetCategories.length) sel.value = prev;
}

// ---- add expense ----
function addExpense() {
  const key = getMonthKey();
  if (!expenseData[key]) expenseData[key] = [];
  const date     = document.getElementById('expDate').value || new Date().toISOString().split('T')[0];
  const name     = document.getElementById('expName').value || 'æœªå…¥åŠ›';
  const amount   = Number(document.getElementById('expAmount').value) || 0;
  const category = Number(document.getElementById('expCategory').value);
  expenseData[key].push({date, name, amount, category});
  document.getElementById('expName').value   = '';
  document.getElementById('expAmount').value = '';
  saveBudgetData();
  renderKakeibo();
}

function deleteExpense(idx) {
  const key = getMonthKey();
  expenseData[key].splice(idx, 1);
  saveBudgetData();
  renderKakeibo();
}

// ---- ã‚¼ãƒ­å††ç¢ºå®šæ—¥ã®æ“ä½œ ----
function toggleZeroDay(dateStr) {
  const monthKey = dateStr.slice(0, 7);
  if (!zeroDays[monthKey]) zeroDays[monthKey] = [];
  const idx = zeroDays[monthKey].indexOf(dateStr);
  if (idx >= 0) zeroDays[monthKey].splice(idx, 1);
  else zeroDays[monthKey].push(dateStr);
  saveBudgetData();
  renderKakeibo();
}

function toggleTodayZero() {
  const dateStr = document.getElementById('expDate')?.value || new Date().toISOString().split('T')[0];
  toggleZeroDay(dateStr);
}

function isZeroDay(dateStr) {
  const monthKey = dateStr.slice(0, 7);
  return (zeroDays[monthKey] || []).includes(dateStr);
}

function updateZeroDayBtn() {
  const dateStr = document.getElementById('expDate')?.value || new Date().toISOString().split('T')[0];
  const btn = document.getElementById('zeroDayBtn');
  const status = document.getElementById('zeroDayStatus');
  if (!btn) return;
  const active = isZeroDay(dateStr);
  btn.textContent = active ? 'âœ“ ã‚¼ãƒ­å††ç¢ºå®šæ¸ˆã¿' : 'ğŸ’¤ ä»Šæ—¥ã¯ã‚¼ãƒ­å††';
  btn.style.background  = active ? 'rgba(62,207,142,0.15)' : '';
  btn.style.borderColor = active ? 'var(--success)' : '';
  btn.style.color       = active ? 'var(--success)' : '';
  if (status) status.textContent = active ? `${dateStr} ã‚’æ”¯å‡ºã‚¼ãƒ­å††ã¨ã—ã¦è¨˜éŒ²ã—ã¦ã„ã¾ã™` : '';
}

// ---- budget settings ----
function getCatBudget(monthKey, catIdx) {
  if (monthCatBudget[monthKey] && monthCatBudget[monthKey][catIdx] != null)
    return monthCatBudget[monthKey][catIdx];
  return budgetCategories[catIdx]?.budget || 0;
}

function getCatBudgets(monthKey) {
  return budgetCategories.map((_, i) => getCatBudget(monthKey, i));
}

function renderBudgetSettings() {
  const div = document.getElementById('budgetSettingsRows');
  if (!div) return;
  const key = getMonthKey();
  const budgets = getCatBudgets(key);
  const totalBudget = budgets.reduce((s,v) => s+v, 0);
  div.innerHTML = `
    <div style="font-size:12px;color:var(--text2);margin-bottom:10px;">
      ${currentYear}å¹´${currentMonth}æœˆã®äºˆç®—åˆè¨ˆ:
      <span style="font-family:var(--mono);color:var(--accent);">${totalBudget.toLocaleString()}å††</span>
      <span style="color:var(--text3);margin-left:8px;">ï¼ˆæœˆã”ã¨ã«å€‹åˆ¥è¨­å®šã§ãã¾ã™ï¼‰</span>
    </div>
    ${budgetCategories.map((c, i) => `
      <div class="budget-settings-row">
        <span class="category-dot" style="background:${CAT_COLORS[i%CAT_COLORS.length]}"></span>
        <span class="cat-label">
          <input class="cat-name-input" type="text" value="${c.name}"
            style="background:var(--bg);border:1px solid var(--border);color:var(--text);
                   padding:4px 8px;border-radius:6px;font-family:var(--sans);font-size:13px;width:100px;">
        </span>
        <input class="cat-budget-input" type="number" value="${budgets[i]}" style="width:120px;" placeholder="äºˆç®—ï¼ˆå††ï¼‰">
        <span style="font-size:12px;color:var(--text3);">å††/æœˆ</span>
        <button class="btn btn-danger btn-sm" onclick="deleteCategory(${i})">å‰Šé™¤</button>
      </div>
    `).join('')}
  `;
}

// ---- main kakeibo render ----
function renderKakeibo() {
  renderBudgetSettings();
  updateExpCategorySelect();
  applyBudgetModeUI();

  // [ä¿®æ­£â‘¡] expenseListWrap ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’ renderKakeibo ã®ãŸã³ã«æ­£ã—ãé©ç”¨
  const expWrap = document.getElementById('expenseListWrap');
  const expIcon = document.getElementById('expenseListToggleIcon');
  if (expWrap) expWrap.style.display = expenseListOpen ? '' : 'none';
  if (expIcon) expIcon.textContent = expenseListOpen ? 'â–² é–‰ã˜ã‚‹' : 'â–¼ é–‹ã';

  const lbl = document.getElementById('kakeiboMonthLabel');
  if (lbl) lbl.textContent = `${currentYear}å¹´${currentMonth}æœˆ`;

  const key = getMonthKey();
  const expenses = expenseData[key] || [];
  const today = new Date();
  const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
  const daysPassed  = (currentYear === today.getFullYear() && currentMonth === today.getMonth()+1)
                      ? today.getDate() : daysInMonth;

  const totalBudget  = getEffectiveTotalBudget();
  const dailyBudget  = totalBudget / daysInMonth;
  const totalSpent   = expenses.reduce((s,e) => s+e.amount, 0);
  const paceKaihi    = (dailyBudget * daysPassed) - totalSpent;
  const projectedEnd = daysInMonth > 0 ? (totalSpent / Math.max(daysPassed,1)) * daysInMonth : 0;
  const projKaihi    = totalBudget - projectedEnd;

  // ä¹–é›¢ãƒœãƒƒã‚¯ã‚¹
  const kaihiBox = document.getElementById('kaihiBox');
  if (kaihiBox) {
    if (totalBudget === 0) {
      kaihiBox.style.display = 'none';
    } else {
      kaihiBox.style.display = '';
      kaihiBox.innerHTML = `
        <div class="kaihi-item"><span class="kaihi-label">æœˆäºˆç®—</span><span class="kaihi-value" style="color:var(--accent)">${totalBudget.toLocaleString()}å††</span></div>
        <div class="kaihi-item"><span class="kaihi-label">1æ—¥äºˆç®—</span><span class="kaihi-value">${Math.round(dailyBudget).toLocaleString()}å††</span></div>
        <div class="kaihi-item"><span class="kaihi-label">ä»Šæœˆã®æ”¯å‡º</span><span class="kaihi-value" style="color:var(--danger)">${totalSpent.toLocaleString()}å††</span></div>
        <div class="kaihi-item">
          <span class="kaihi-label">ãƒšãƒ¼ã‚¹ä¹–é›¢</span>
          <span class="kaihi-value" style="color:${paceKaihi>=0?'var(--success)':'var(--danger)'}">
            ${paceKaihi>=0?'â–¼ç¯€ç´„ ':'â–²è¶…é '}${Math.abs(Math.round(paceKaihi)).toLocaleString()}å††
          </span>
        </div>
        <div class="kaihi-item">
          <span class="kaihi-label">æœˆæœ«ç€åœ°äºˆæ¸¬</span>
          <span class="kaihi-value" style="color:${projKaihi>=0?'var(--success)':'var(--danger)'}">
            ${Math.round(projectedEnd).toLocaleString()}å††
            <span style="font-size:13px;">(${projKaihi>=0?'â–¼':'â–²'}${Math.abs(Math.round(projKaihi)).toLocaleString()}å††)</span>
          </span>
        </div>
        <div class="kaihi-item">
          <span class="kaihi-label">æ®‹äºˆç®—</span>
          <span class="kaihi-value" style="color:${(totalBudget-totalSpent)>=0?'var(--success)':'var(--danger)'}">
            ${(totalBudget-totalSpent).toLocaleString()}å††
          </span>
        </div>
      `;
    }
  }

  // ãƒšãƒ¼ã‚¹ãƒãƒ¼
  const paceSection = document.getElementById('paceSection');
  if (paceSection) {
    if (totalBudget === 0) {
      paceSection.style.display = 'none';
    } else {
      paceSection.style.display = '';
      const spentPct = Math.min(totalSpent / totalBudget * 100, 100);
      const timePct  = Math.min(daysPassed / daysInMonth * 100, 100);
      const barColor = spentPct > timePct + 5 ? 'var(--danger)' : spentPct < timePct - 5 ? 'var(--success)' : 'var(--accent)';
      paceSection.innerHTML = `
        <div style="margin-bottom:6px;font-size:13px;color:var(--text2);">å…¨ä½“ãƒšãƒ¼ã‚¹ï¼ˆ${daysPassed}/${daysInMonth}æ—¥çµŒéï¼‰</div>
        <div class="pace-bar-wrap">
          <label>æ”¯å‡ºé€²æ—</label>
          <div class="pace-bar">
            <div class="pace-fill" style="width:${spentPct}%;background:${barColor};"></div>
            <div class="pace-marker" style="left:${timePct}%;"></div>
          </div>
          <span class="pace-value" style="color:${barColor};">${Math.round(spentPct)}%</span>
        </div>
        <div style="font-size:11px;color:var(--text3);margin-top:4px;">â”‚ = æ™‚é–“çµŒé ${Math.round(timePct)}%ï¼ˆé»„ç·šï¼‰</div>
      `;
    }
  }

  // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚«ãƒ¼ãƒ‰
  const catGrid = document.getElementById('budgetCatGrid');
  if (catGrid) {
    if (budgetCategories.length === 0) {
      catGrid.innerHTML = '<div class="empty-state">ã‚«ãƒ†ã‚´ãƒªã‚’è¨­å®šã—ã¦ãã ã•ã„</div>';
    } else {
      const budgets = getCatBudgets(key);
      catGrid.innerHTML = budgetCategories.map((c, i) => {
        const budget = budgets[i];
        const spent  = expenses.filter(e => e.category === i).reduce((s,e) => s+e.amount, 0);
        const pct    = budget > 0 ? Math.min(spent / budget * 100, 100) : 0;
        const over   = spent > budget;
        const color  = pct > 90 ? 'var(--danger)' : pct > 70 ? 'var(--warn)' : CAT_COLORS[i%CAT_COLORS.length];
        const remain = budget - spent;
        return `
          <div class="budget-cat-card">
            <div class="cat-name">
              <span class="category-dot" style="background:${CAT_COLORS[i%CAT_COLORS.length]}"></span>
              ${c.name}
            </div>
            <div class="cat-budget">äºˆç®— ${budget.toLocaleString()}å††</div>
            <div class="budget-progress-bar">
              <div class="budget-progress-fill" style="width:${pct}%;background:${color};"></div>
            </div>
            <div class="cat-stats">
              <span class="cat-spent">${spent.toLocaleString()}å††</span>
              <span class="cat-remain ${over?'over':'ok'}">${over?'â–²è¶…':'æ®‹'}${Math.abs(remain).toLocaleString()}å††</span>
            </div>
          </div>
        `;
      }).join('');
    }
  }

  // æ”¯å‡ºãƒªã‚¹ãƒˆ
  const expList = document.getElementById('expenseList');
  if (expList) {
    if (expenses.length === 0) {
      expList.innerHTML = '<div class="empty-state">æ”¯å‡ºãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
    } else {
      const sorted = [...expenses.map((e,i)=>({...e,i}))].sort((a,b)=>b.date.localeCompare(a.date));
      expList.innerHTML = `
        <table class="expense-table">
          <tr><th>æ—¥ä»˜</th><th>å“ç›®</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>é‡‘é¡</th><th></th></tr>
          ${sorted.map(e => `
            <tr>
              <td style="font-family:var(--mono);color:var(--text3)">${e.date}</td>
              <td>${e.name}</td>
              <td>
                <span style="display:inline-flex;align-items:center;gap:5px;font-size:12px;">
                  <span class="category-dot" style="background:${CAT_COLORS[e.category%CAT_COLORS.length]}"></span>
                  ${budgetCategories[e.category]?.name || '?'}
                </span>
              </td>
              <td style="font-family:var(--mono);color:var(--danger);">-${e.amount.toLocaleString()}å††</td>
              <td style="display:flex;gap:4px;justify-content:flex-end;">
                <button class="tx-edit" onclick="editExpense(${e.i})">âœï¸</button>
                <button class="tx-del" onclick="deleteExpense(${e.i})">âœ•</button>
              </td>
            </tr>
          `).join('')}
        </table>
      `;
    }
  }

  // æ—¥åˆ¥æ”¯å‡ºè¡¨
  renderDailyTable(expenses, daysInMonth, dailyBudget, today);
  updateZeroDayBtn();
}

// ============================================================
// Daily Table
// ============================================================
function renderDailyTable(expenses, daysInMonth, dailyBudget, today) {
  const wrap = document.getElementById('dailyTableWrap');
  if (!wrap) return;

  const isCurrentMonth = (currentYear === today.getFullYear() && currentMonth === today.getMonth() + 1);
  const todayDay  = isCurrentMonth ? today.getDate() : -1;
  const DOW       = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const targetRound = Math.round(dailyBudget);

  const dayMap = {};
  for (let d = 1; d <= daysInMonth; d++) dayMap[d] = [];
  expenses.forEach(e => {
    const day = parseInt(e.date.split('-')[2], 10);
    if (dayMap[day]) dayMap[day].push(e);
  });

  const maxItems = Math.max(1, ...Object.values(dayMap).map(a => a.length));

  const blankHeaders = Array.from({length: maxItems}, (_, i) =>
    `<th class="th-expense">${i === 0 ? 'æ”¯å‡º' : ''}</th>`
  ).join('');

  let html = `<table class="daily-table">
    <thead>
      <tr>
        <th class="th-date">æ—¥</th>
        ${blankHeaders}
        <th class="th-summary">å°è¨ˆ</th>
        <th class="th-summary">1æ—¥ç›®æ¨™</th>
        <th class="th-summary">å·®é¡</th>
      </tr>
    </thead>
    <tbody>`;

  for (let d = 1; d <= daysInMonth; d++) {
    const date      = new Date(currentYear, currentMonth - 1, d);
    const dow       = date.getDay();
    const isToday   = d === todayDay;
    const isWeekend = dow === 0 || dow === 6;
    const items     = dayMap[d];
    const dayTotal  = items.reduce((s, e) => s + e.amount, 0);
    const diff      = targetRound - dayTotal;
    const dateStr   = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isZero    = isZeroDay(dateStr);

    let dateClass = 'td-date';
    if (isToday) dateClass += ' today';
    else if (isWeekend) dateClass += ' weekend';

    const expCells = Array.from({length: maxItems}, (_, i) => {
      const e = items[i];
      if (!e) {
        if (i === 0 && dayTotal === 0) {
          return `<td class="td-expense td-expense-empty" style="vertical-align:middle;text-align:center;">
            <button onclick="toggleZeroDay('${dateStr}')" style="
              background:${isZero ? 'rgba(62,207,142,0.15)' : 'rgba(255,255,255,0.04)'};
              border:1px solid ${isZero ? 'var(--success)' : 'var(--border)'};
              color:${isZero ? 'var(--success)' : 'var(--text3)'};
              border-radius:6px; padding:3px 8px; font-size:11px; cursor:pointer;
              font-family:var(--sans); transition:all 0.15s;
            ">${isZero ? 'âœ“ Â¥0ç¢ºå®š' : 'Â¥0 ç¢ºå®š'}</button>
          </td>`;
        }
        return `<td class="td-expense td-expense-empty"></td>`;
      }
      const catName  = budgetCategories[e.category]?.name || '?';
      const catColor = CAT_COLORS[e.category % CAT_COLORS.length];
      return `<td class="td-expense">
        <div class="exp-cell-inner">
          <span class="exp-name">${e.name}</span>
          <span class="exp-amount">${e.amount.toLocaleString()}å††</span>
          <span class="exp-cat" style="color:${catColor};border-color:${catColor};">${catName}</span>
        </div>
      </td>`;
    }).join('');

    const totalHTML = dayTotal > 0
      ? `<span class="summary-total">${dayTotal.toLocaleString()}</span>`
      : isZero ? `<span style="font-family:var(--mono);font-size:12px;color:var(--success);">0</span>` : '';
    const diffColor = isZero ? 'var(--success)' : dayTotal === 0 ? 'var(--text3)' : diff >= 0 ? 'var(--success)' : 'var(--danger)';
    const diffHTML  = dayTotal > 0
      ? `<span style="font-family:var(--mono);font-size:12px;color:${diffColor};">${diff>=0?'â–¼':'â–²'}${Math.abs(diff).toLocaleString()}</span>`
      : isZero ? `<span style="font-family:var(--mono);font-size:12px;color:var(--success);">â–¼${targetRound.toLocaleString()}</span>` : '';

    html += `<tr class="${isToday ? 'row-today' : ''}">
      <td class="${dateClass}">${d}<br><span style="font-size:10px;">${DOW[dow]}</span></td>
      ${expCells}
      <td class="td-summary-total">${totalHTML}</td>
      <td class="td-summary-target">${targetRound.toLocaleString()}</td>
      <td class="td-summary-diff">${diffHTML}</td>
    </tr>`;
  }

  const grandActual = expenses.reduce((s,e) => s+e.amount, 0);
  const grandTarget = targetRound * daysInMonth;
  const grandDiff   = grandTarget - grandActual;

  html += `</tbody>
    <tfoot>
      <tr>
        <td style="text-align:center;color:var(--text2);font-size:12px;">åˆè¨ˆ</td>
        ${Array.from({length: maxItems}, () => '<td></td>').join('')}
        <td class="foot-actual">${grandActual.toLocaleString()}</td>
        <td class="foot-target">${grandTarget.toLocaleString()}</td>
        <td class="${grandDiff>=0?'foot-ok':'foot-over'}">${grandDiff>=0?'â–¼':'â–²'}${Math.abs(grandDiff).toLocaleString()}</td>
      </tr>
    </tfoot>
  </table>`;

  wrap.innerHTML = html;
}

// ============================================================
// Modal
// ============================================================
function openModal(title, bodyHTML, onSave) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = bodyHTML;
  document.getElementById('modalSaveBtn').onclick = () => { onSave(); closeModalDirect(); };
  document.getElementById('editModal').classList.add('open');
}
function closeModal(e) {
  if (e.target === document.getElementById('editModal')) closeModalDirect();
}
function closeModalDirect() {
  document.getElementById('editModal').classList.remove('open');
}

function editForecastTx(type, idx) {
  const key  = getMonthKey();
  const item = monthData[key][type][idx];
  const body = `
    <div class="modal-field"><label>æ—¥ä»˜</label><input type="date" id="mDate" value="${item.date}"></div>
    <div class="modal-field"><label>åå‰</label><input type="text" id="mName" value="${item.name}"></div>
    <div class="modal-field"><label>é‡‘é¡ï¼ˆå††ï¼‰</label><input type="number" id="mAmount" value="${item.amount}"></div>
    <div class="modal-field"><label>å£åº§</label><select id="mAccount">
      ${accounts.map((a,i) => `<option value="${i}" ${i===item.account?'selected':''}>${a.name}</option>`).join('')}
    </select></div>`;
  openModal(`äºˆæ¸¬${type==='incomes'?'å…¥é‡‘':'æ”¯æ‰•ã„'}ã‚’ç·¨é›†`, body, () => {
    monthData[key][type][idx] = {
      date:    document.getElementById('mDate').value,
      name:    document.getElementById('mName').value,
      amount:  Number(document.getElementById('mAmount').value),
      account: Number(document.getElementById('mAccount').value),
    };
    saveData(); renderForecastList(); renderDashboard();
  });
}

function editActualTx(type, idx) {
  const key  = getMonthKey();
  const item = actualData[key][type][idx];
  const body = `
    <div class="modal-field"><label>æ—¥ä»˜</label><input type="date" id="mDate" value="${item.date}"></div>
    <div class="modal-field"><label>åå‰</label><input type="text" id="mName" value="${item.name}"></div>
    <div class="modal-field"><label>é‡‘é¡ï¼ˆå††ï¼‰</label><input type="number" id="mAmount" value="${item.amount}"></div>
    <div class="modal-field"><label>å£åº§</label><select id="mAccount">
      ${accounts.map((a,i) => `<option value="${i}" ${i===item.account?'selected':''}>${a.name}</option>`).join('')}
    </select></div>`;
  openModal(`å®Ÿç¸¾${type==='incomes'?'å…¥é‡‘':'æ”¯æ‰•ã„'}ã‚’ç·¨é›†`, body, () => {
    actualData[key][type][idx] = {
      date:    document.getElementById('mDate').value,
      name:    document.getElementById('mName').value,
      amount:  Number(document.getElementById('mAmount').value),
      account: Number(document.getElementById('mAccount').value),
    };
    saveData(); renderActualList();
  });
}

function editExpense(idx) {
  const key  = getMonthKey();
  const item = expenseData[key][idx];
  const body = `
    <div class="modal-field"><label>æ—¥ä»˜</label><input type="date" id="mDate" value="${item.date}"></div>
    <div class="modal-field"><label>å“ç›®</label><input type="text" id="mName" value="${item.name}"></div>
    <div class="modal-field"><label>é‡‘é¡ï¼ˆå††ï¼‰</label><input type="number" id="mAmount" value="${item.amount}"></div>
    <div class="modal-field"><label>ã‚«ãƒ†ã‚´ãƒª</label><select id="mCat">
      ${budgetCategories.map((c,i) => `<option value="${i}" ${i===item.category?'selected':''}>${c.name}</option>`).join('')}
    </select></div>`;
  openModal('æ”¯å‡ºã‚’ç·¨é›†', body, () => {
    expenseData[key][idx] = {
      date:     document.getElementById('mDate').value,
      name:     document.getElementById('mName').value,
      amount:   Number(document.getElementById('mAmount').value),
      category: Number(document.getElementById('mCat').value),
    };
    saveBudgetData(); renderKakeibo();
  });
}

// ============================================================
// Export / Import
// ============================================================
function exportData() {
  const payload = {
    version: 1,
    exportedAt: new Date().toISOString(),
    accounts, monthData, actualData, budgetCategories, expenseData,
    monthTotalBudget, budgetMode, zeroDays, monthBalances, monthCatBudget,
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  const date = new Date().toISOString().split('T')[0];
  a.href = url; a.download = `kaikei-backup-${date}.json`; a.click();
  URL.revokeObjectURL(url);
  const st = document.getElementById('exportStatus');
  if (st) { st.textContent = `âœ“ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†ï¼ˆ${date}ï¼‰`; setTimeout(() => st.textContent = '', 4000); }
}

function importData(input) {
  const file = input.files[0];
  if (!file) return;
  const st = document.getElementById('importStatus');
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.version || !data.accounts) throw new Error('ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
      if (!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦ä¸Šæ›¸ãã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) { input.value = ''; return; }

      accounts         = data.accounts         || [];
      monthData        = data.monthData         || {};
      actualData       = data.actualData        || {};
      budgetCategories = data.budgetCategories  || [];
      expenseData      = data.expenseData       || {};
      monthTotalBudget = data.monthTotalBudget  || {};
      budgetMode       = data.budgetMode        || 'category';
      zeroDays         = data.zeroDays          || {};
      monthBalances    = data.monthBalances     || {};
      monthCatBudget   = data.monthCatBudget    || {};

      saveData(); saveBudgetData();
      localStorage.setItem('accounts', JSON.stringify(accounts));

      renderAccountSettings(); updateAccountSelects(); updateExpCategorySelect();
      renderDashboard(); renderForecastList(); renderActualList();

      if (st) { st.style.color = 'var(--success)'; st.textContent = `âœ“ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼ï¼ˆ${data.exportedAt?.split('T')[0] || ''}ï¼‰`; }
    } catch(err) {
      if (st) { st.style.color = 'var(--danger)'; st.textContent = `âœ— ã‚¨ãƒ©ãƒ¼: ${err.message}`; }
    }
    input.value = '';
  };
  reader.readAsText(file);
}

// ============================================================
// Run
// ============================================================
init();
</script>
</body>
</html>
